rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Coleção de usuários
    match /users/{userId} {
      // Usuário pode ler seus próprios dados
      allow read: if request.auth.uid == userId;
      
      // Usuário pode escrever seus próprios dados
      allow write: if request.auth.uid == userId;
      
      // Permitir leitura pública do referralCode para validação no cadastro
      allow read: if request.auth != null && resource.data.userType == 'personal';
    }

    // Coleção de exercícios
    match /exercises/{exerciseId} {
      // Qualquer usuário autenticado pode ler
      allow read: if request.auth != null;
      // Apenas o criador pode escrever/deletar
      allow write: if request.auth.uid == resource.data.createdBy || 
                      request.auth.uid == request.resource.data.createdBy;
    }

    // Coleção de treinos
    match /workouts/{workoutId} {
      // Personal pode ler seus próprios treinos
      // Aluno pode ler treinos atribuídos a ele
      allow read: if request.auth.uid == resource.data.personalId || 
                     request.auth.uid == resource.data.studentId;
      
      // Apenas o Personal pode criar/editar/deletar
      allow write: if request.auth.uid == resource.data.personalId || 
                      request.auth.uid == request.resource.data.personalId;
    }

    // Negar acesso padrão
    match /{document=**} {
      allow read, write: if false;
    }
  }
}