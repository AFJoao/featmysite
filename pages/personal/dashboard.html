<div class="personal-dashboard">
  <header style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <h1 style="color: #ffffff; font-size: 24px; font-weight: 600; margin: 0;">Dashboard Personal</h1>
      </div>

      <nav style="display: flex; gap: 12px; align-items: center;">
        <a href="#/personal/exercises" style="background: transparent; color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px 18px; border-radius: 6px; text-decoration: none; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6"></path>
            <path d="m4.93 4.93 4.24 4.24m5.66 5.66 4.24 4.24"></path>
            <path d="m19.07 4.93-4.24 4.24m-5.66 5.66-4.24 4.24"></path>
          </svg>
          ExercÃ­cios
        </a>

        <a href="#/personal/create-workout" style="background: #ffffff; color: #000000; border: 1px solid #ffffff; padding: 10px 18px; border-radius: 6px; text-decoration: none; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Criar Treino
        </a>

        <button id="logoutBtn" style="background: transparent; color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px 18px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Sair
        </button>
      </nav>
    </div>
  </header>

  <div style="max-width: 1400px; margin: 0 auto; padding: 30px 20px;">
    
    <div style="margin-bottom: 30px;">
      <h2 style="font-size: 28px; font-weight: 600; margin: 0 0 8px 0;">OlÃ¡, <span id="personalName">...</span>! ðŸ‘‹</h2>
      <p style="color: #666; font-size: 16px; margin: 0;">Gerencie seus alunos e treinos</p>
    </div>

    <!-- REFERRAL CODE -->
    <div style="background: linear-gradient(135deg, #000000 0%, #2d2d2d 100%); border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2">
          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
          <line x1="7" y1="7" x2="7.01" y2="7"></line>
        </svg>
        <h3 style="color: #ffffff; font-size: 20px; font-weight: 600; margin: 0;">Seu CÃ³digo de ReferÃªncia</h3>
      </div>

      <div style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 25px;">
        <p style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 15px;">Compartilhe este cÃ³digo com seus alunos:</p>

        <div style="background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px;">
          <p id="referralCode" style="font-size: 36px; font-weight: 700; letter-spacing: 8px; color: #ffffff; margin: 0; font-family: 'Courier New', monospace;">------</p>
        </div>

        <button id="copyCodeBtn" style="background: #ffffff; color: #000000; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; transition: all 0.2s;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copiar CÃ³digo
        </button>
      </div>
    </div>

    <!-- STUDENTS LIST -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Meus Alunos
        <span id="studentsCount" style="background:#000; color:#fff; padding:4px 12px; border-radius:20px; font-size:14px; font-weight:600;">0</span>
      </h3>

      <button id="reloadStudentsBtn" style="background:transparent; color:#000; border:1px solid #e0e0e0; padding:10px 18px; border-radius:6px; cursor:pointer;">
        Atualizar
      </button>
    </div>

    <div id="studentsList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:20px; margin-bottom:40px;">
      <div style="text-align:center; padding:60px 20px; grid-column:1 / -1;">
        <div class="spinner" style="margin:0 auto 20px;"></div>
        <p style="color:#999;">Carregando alunos...</p>
      </div>
    </div>
  </div>
</div>

<script>
(async function() {

  let currentReferralCode = "";
  let isLoading = false;
  let allStudents = [];

  await new Promise(res => document.readyState === "loading"
    ? document.addEventListener("DOMContentLoaded", res)
    : res()
  );

  await new Promise(r => setTimeout(r, 120));

  /* LOGOUT */
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.onclick = async () => {
      await authManager.logout();
      router.goToLogin();
    };
  }

  /* COPY CODE */
  const copyCodeBtn = document.getElementById("copyCodeBtn");
  if (copyCodeBtn) {
    copyCodeBtn.onclick = () => {
      navigator.clipboard.writeText(currentReferralCode).then(() => {
        const html = copyCodeBtn.innerHTML;
        copyCodeBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Copiado!
        `;
        setTimeout(() => copyCodeBtn.innerHTML = html, 2000);
      });
    };
  }

  /* RELOAD */
  const reloadStudentsBtn = document.getElementById("reloadStudentsBtn");
  reloadStudentsBtn.onclick = () => loadStudents();

  /* LOAD PERSONAL */
  async function loadPersonalData() {
    const name = document.getElementById("personalName");
    const code = document.getElementById("referralCode");

    const data = await dbManager.getCurrentUserData();

    name.textContent = data?.name || "Personal";
    currentReferralCode = data?.referralCode || "ERRO";
    code.textContent = currentReferralCode;
  }

  /* LOAD STUDENTS */
  async function loadStudents() {
    if (isLoading) return;
    isLoading = true;

    const list = document.getElementById("studentsList");
    const count = document.getElementById("studentsCount");

    list.innerHTML = `
      <div style="grid-column:1/-1; text-align:center; padding:60px;">
        <div class="spinner"></div>
        <p>Carregando alunos...</p>
      </div>
    `;

    const students = await dbManager.getMyStudents();
    allStudents = students;

    count.textContent = students.length;

    if (students.length === 0) {
      list.innerHTML = `
        <div style="grid-column:1/-1; padding:50px; background:#fafafa; border-radius:12px; text-align:center; border:2px dashed #ccc;">
          <p style="font-size:18px; color:#777;">Nenhum aluno vinculado ainda</p>
        </div>
      `;
      return isLoading = false;
    }

    list.innerHTML = "";
    
    students.forEach(st => {
      const card = document.createElement("div");
      card.style = `
        background:#fff; border:1px solid #eaeaea; border-radius:10px;
        padding:20px; cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,0.05);
      `;

      card.innerHTML = `
        <h4 style="font-size:20px; margin:0 0 8px 0;">${st.name}</h4>
        <p style="margin:0; color:#555;">Email: ${st.email}</p>
      `;

      card.onclick = () => router.goTo(`/personal/student/${st.uid}`);

      list.appendChild(card);
    });

    isLoading = false;
  }

  /* RUN EVERYTHING */
  await loadPersonalData();
  await loadStudents();

})();
</script>

<style>
.spinner {
  width: 32px;
  height: 32px;
  border: 4px solid #ddd;
  border-top-color: #000;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>