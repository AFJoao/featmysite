<div class="personal-dashboard">
  <header>
    <h1>Personal Trainer - Dashboard</h1>
    <nav>
      <a href="#/personal/exercises">Exerc√≠cios</a>
      <a href="#/personal/create-workout">Criar Treino</a>
      <a href="#" id="logoutBtn">Sair</a>
    </nav>
  </header>

  <div style="max-width: 1000px; margin: 30px auto;">
    <h2>Bem-vindo, <span id="personalName">Carregando...</span>!</h2>
    
    <!-- Card com C√≥digo de Refer√™ncia -->
    <div class="card" style="background-color: #000000; color: #ffffff; margin: 20px 0;">
      <h3 style="margin-bottom: 10px;">Seu C√≥digo de Refer√™ncia</h3>
      <p style="font-size: 32px; font-weight: bold; letter-spacing: 5px; margin: 15px 0;" id="referralCode">------</p>
      <p style="margin-top: 10px; font-size: 14px;">Compartilhe este c√≥digo com seus alunos para que eles possam se vincular a voc√™ no cadastro.</p>
      <button id="copyCodeBtn" class="secondary" style="margin-top: 15px; background-color: #ffffff; color: #000000;">
        üìã Copiar C√≥digo
      </button>
    </div>

    <!-- Meus Alunos -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px;">
      <h3 style="margin: 0;">Meus Alunos (<span id="studentsCount">0</span>)</h3>
      <button id="reloadStudentsBtn" class="secondary" style="padding: 8px 15px; font-size: 12px;">
        üîÑ Atualizar Lista
      </button>
    </div>
    <div id="studentsList" class="students-list">
      <div class="loading"><div class="spinner"></div><p>Carregando alunos...</p></div>
    </div>

    <!-- Meus Treinos -->
    <h3 style="margin-top: 30px; margin-bottom: 15px;">Meus Treinos</h3>
    <div id="workoutsList" class="workouts-list">
      <div class="loading"><div class="spinner"></div><p>Carregando treinos...</p></div>
    </div>
  </div>
</div>

<script>
(async function() {
  console.log('=== DASHBOARD DO PERSONAL - INICIANDO ===');

  let currentReferralCode = '';
  let isLoading = false;

  // Aguardar DOM estar pronto
  await new Promise(resolve => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });

  console.log('‚úì DOM pronto');

  // Aguardar elementos estarem no DOM
  await new Promise(resolve => setTimeout(resolve, 100));

  // Verificar se elementos existem
  const logoutBtn = document.getElementById('logoutBtn');
  const copyCodeBtn = document.getElementById('copyCodeBtn');
  const reloadStudentsBtn = document.getElementById('reloadStudentsBtn');

  if (!logoutBtn) {
    console.error('‚ùå Bot√£o logout n√£o encontrado!');
    return;
  }

  console.log('‚úì Elementos encontrados');

  // Logout
  logoutBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    console.log('Fazendo logout...');
    await authManager.logout();
    router.goToLogin();
  });

  // Copiar c√≥digo de refer√™ncia
  if (copyCodeBtn) {
    copyCodeBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(currentReferralCode).then(() => {
        alert('‚úì C√≥digo copiado!\n\nCompartilhe este c√≥digo com seus alunos para que eles possam se vincular a voc√™ no cadastro.');
      }).catch(err => {
        const textarea = document.createElement('textarea');
        textarea.value = currentReferralCode;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('‚úì C√≥digo copiado!');
      });
    });
  }

  // Recarregar alunos
  if (reloadStudentsBtn) {
    reloadStudentsBtn.addEventListener('click', () => {
      console.log('Recarregando alunos...');
      loadStudents();
    });
  }

  // Carregar dados do Personal
  async function loadPersonalData() {
    try {
      console.log('=== CARREGANDO DADOS DO PERSONAL ===');
      
      const personalNameSpan = document.getElementById('personalName');
      const referralCodeP = document.getElementById('referralCode');

      if (!personalNameSpan || !referralCodeP) {
        console.error('‚ùå Elementos n√£o encontrados');
        return;
      }

      const userData = await dbManager.getCurrentUserData();
      console.log('Dados do usu√°rio:', userData);
      
      if (userData) {
        personalNameSpan.textContent = userData.name || 'Personal';
        
        if (userData.referralCode) {
          currentReferralCode = userData.referralCode;
          referralCodeP.textContent = userData.referralCode;
          console.log('‚úì C√≥digo de refer√™ncia:', userData.referralCode);
        } else {
          console.warn('‚ö†Ô∏è Personal n√£o tem c√≥digo de refer√™ncia!');
          referralCodeP.textContent = 'ERRO';
        }
      } else {
        console.error('‚ùå Dados do usu√°rio n√£o encontrados');
      }

      console.log('‚úì Dados do personal carregados');
    } catch (error) {
      console.error('‚ùå Erro ao carregar dados do personal:', error);
    }
  }

  // Carregar alunos
  async function loadStudents() {
    if (isLoading) {
      console.log('J√° est√° carregando, aguarde...');
      return;
    }

    try {
      isLoading = true;
      console.log('=== CARREGANDO LISTA DE ALUNOS ===');
      
      const studentsList = document.getElementById('studentsList');
      const studentsCount = document.getElementById('studentsCount');

      if (!studentsList || !studentsCount) {
        console.error('‚ùå Elementos da lista n√£o encontrados');
        return;
      }

      studentsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando alunos...</p></div>';

      const students = await dbManager.getMyStudents();
      console.log('Alunos retornados:', students);

      studentsCount.textContent = students.length;

      if (students.length === 0) {
        studentsList.innerHTML = `
          <div class="card" style="background-color: #f5f5f5;">
            <p style="margin: 0; color: #666;">
              Nenhum aluno vinculado ainda.<br>
              <strong>Como vincular alunos:</strong><br>
              1. Compartilhe seu c√≥digo de refer√™ncia acima<br>
              2. Seus alunos devem usar este c√≥digo ao se cadastrarem como "Aluno"
            </p>
          </div>
        `;
      } else {
        studentsList.innerHTML = students.map(student => `
          <div class="card">
            <h4>üë§ ${student.name}</h4>
            <p><strong>Email:</strong> ${student.email}</p>
            <p><strong>Cadastrado em:</strong> ${student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A'}</p>
          </div>
        `).join('');
      }

      console.log('‚úì Lista de alunos atualizada');
    } catch (error) {
      console.error('=== ERRO AO CARREGAR ALUNOS ===');
      console.error('Erro completo:', error);
      
      const studentsList = document.getElementById('studentsList');
      if (studentsList) {
        studentsList.innerHTML = `
          <div class="card" style="border-color: #cc0000;">
            <p style="color: #cc0000;">
              <strong>Erro ao carregar alunos.</strong><br>
              ${error.message}
            </p>
          </div>
        `;
      }
    } finally {
      isLoading = false;
    }
  }

  // Carregar treinos
  async function loadWorkouts() {
    try {
      console.log('=== CARREGANDO TREINOS ===');
      
      const workoutsList = document.getElementById('workoutsList');
      if (!workoutsList) {
        console.error('‚ùå Elemento workoutsList n√£o encontrado');
        return;
      }

      const workouts = await dbManager.getPersonalWorkouts();
      console.log('Treinos retornados:', workouts);

      if (workouts.length === 0) {
        workoutsList.innerHTML = '<p>Nenhum treino criado ainda. <a href="#/personal/create-workout">Criar novo treino</a></p>';
      } else {
        // Buscar nomes dos alunos
        const studentsMap = {};
        const students = await dbManager.getMyStudents();
        students.forEach(s => {
          studentsMap[s.uid] = s.name;
        });

        workoutsList.innerHTML = workouts.map(workout => {
          const daysCount = Object.keys(workout.days || {}).filter(day => {
            return workout.days[day] && workout.days[day].length > 0;
          }).length;
          
          const studentName = workout.studentId && studentsMap[workout.studentId] 
            ? studentsMap[workout.studentId] 
            : 'N√£o associado';
          
          return `
            <div class="card">
              <h4>${workout.name}</h4>
              <p>${workout.description}</p>
              <p><strong>Dias:</strong> ${daysCount} dia(s)</p>
              <p><strong>Aluno:</strong> ${studentName}</p>
              <div style="margin-top: 10px;">
                <button class="delete-workout-btn danger" data-workout-id="${workout.id}">Deletar</button>
              </div>
            </div>
          `;
        }).join('');

        // Adicionar event listeners aos bot√µes de deletar
        document.querySelectorAll('.delete-workout-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const workoutId = btn.getAttribute('data-workout-id');
            await deleteWorkout(workoutId);
          });
        });
      }

      console.log('‚úì Treinos carregados');
    } catch (error) {
      console.error('‚ùå Erro ao carregar treinos:', error);
      const workoutsList = document.getElementById('workoutsList');
      if (workoutsList) {
        workoutsList.innerHTML = '<p>Erro ao carregar treinos.</p>';
      }
    }
  }

  // Deletar treino
  async function deleteWorkout(workoutId) {
    console.log('Deletando treino:', workoutId);
    
    if (confirm('‚ö†Ô∏è Tem certeza que deseja deletar este treino?')) {
      const result = await dbManager.deleteWorkout(workoutId);
      if (result.success) {
        alert('‚úì Treino deletado com sucesso!');
        loadWorkouts();
      } else {
        alert('‚ùå Erro ao deletar treino: ' + result.error);
      }
    }
  }

  // CARREGAR TUDO EM SEQU√äNCIA
  console.log('Iniciando carregamento completo...');
  
  await loadPersonalData();
  await loadStudents();
  await loadWorkouts();
  
  console.log('=== DASHBOARD TOTALMENTE CARREGADO ===');
})();
</script>

<style>
  .students-list .card,
  .workouts-list .card {
    margin-bottom: 15px;
  }

  .students-list .card h4 {
    margin-bottom: 10px;
  }
</style>