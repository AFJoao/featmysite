<div class="create-workout-page">
  <link rel="stylesheet" href="css/mobile-responsive-fixes.css">
  <link rel="stylesheet" href="css/page-create-workout.css">

  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <h1>Criar Treino</h1>
      </div>
      <div class="header-nav">
        <a href="#/personal/dashboard" class="btn">Dashboard</a>
        <a href="#/personal/exercises" class="btn">Exercícios</a>
        <button class="btn" id="logoutBtn">Sair</button>
      </div>
    </div>
  </div>

  <div id="pageLoading">
    <div class="spinner"></div>
    <p>Carregando dados...</p>
  </div>

  <div id="mainContent">
    <div class="container">
      <div class="grid-2">
        <div>
          <div class="section">
            <h2>Informações do Treino</h2>
            
            <div id="createError" class="alert error" style="display: none;"></div>
            <div id="createSuccess" class="alert success" style="display: none;"></div>

            <div class="form-group">
              <label for="workoutName">Nome do Treino *</label>
              <input type="text" id="workoutName" placeholder="Ex: Treino A - Peito e Tríceps">
            </div>

            <div class="form-group">
              <label for="workoutDescription">Descrição</label>
              <textarea id="workoutDescription" placeholder="Descreva os objetivos e observações do treino..."></textarea>
            </div>

            <div class="form-group">
              <label for="studentSelect">Aluno *</label>
              <select id="studentSelect">
                <option value="">-- Selecione um aluno --</option>
              </select>
              <small style="display: block; margin-top: 5px; color: #666;">Escolha o aluno que receberá este treino</small>
            </div>
          </div>

          <div class="section spaced">
            <h2>Dias da Semana</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Selecione um dia e adicione exercícios abaixo</p>
            <div class="days-grid" id="daysGrid">
              <div class="day-box" data-day="monday">Segunda</div>
              <div class="day-box" data-day="tuesday">Terça</div>
              <div class="day-box" data-day="wednesday">Quarta</div>
              <div class="day-box" data-day="thursday">Quinta</div>
              <div class="day-box" data-day="friday">Sexta</div>
              <div class="day-box" data-day="saturday">Sábado</div>
              <div class="day-box" data-day="sunday">Domingo</div>
            </div>
            <div id="selectedDayInfo" class="selected-day-info">
              <p style="margin: 0; font-size: 13px; color: #856404;">
                <strong>Dia selecionado:</strong> <span id="selectedDayName"></span><br>
                <small>Adicione exercícios usando os botões abaixo</small>
              </p>
            </div>
          </div>

          <div class="section spaced">
            <h2>Exercícios Disponíveis (<span id="exercisesCount">0</span>)</h2>
            <div id="availableExercises" class="exercises-list">
              <div class="empty">
                <div class="spinner"></div>
                <p>Carregando exercícios...</p>
              </div>
            </div>
          </div>

          <button id="clearSelectionBtn" class="btn-secondary full-width">Limpar Seleção</button>
          <button id="saveWorkoutBtn" class="btn-primary">Salvar Treino</button>
        </div>

        <div>
          <div class="section sticky">
            <h2>Visualização do Treino</h2>
            <div id="workoutPreview" class="preview-box">
              <p class="empty">A visualização aparecerá aqui...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(async function() {
  console.log('=== PÁGINA CRIAR TREINO - INICIANDO ===');

  const DAYS_MAP = {
    monday: 'Segunda-feira',
    tuesday: 'Terça-feira',
    wednesday: 'Quarta-feira',
    thursday: 'Quinta-feira',
    friday: 'Sexta-feira',
    saturday: 'Sábado',
    sunday: 'Domingo'
  };
  const DAYS_ORDER = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

  const state = {
    selectedDay: null,
    dayExercises: {},
    exercisesMap: {}
  };

  DAYS_ORDER.forEach(day => {
    state.dayExercises[day] = [];
  });

  await new Promise(resolve => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });

  await new Promise(resolve => setTimeout(resolve, 100));

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await authManager.logout();
    router.goToLogin();
  });

  // Carregar alunos
  async function loadStudents() {
    try {
      const students = await dbManager.getAllStudents();
      const select = document.getElementById('studentSelect');
      
      const preselectedId = sessionStorage.getItem('preselectedStudentId');
      
      students.forEach(s => {
        const option = document.createElement('option');
        option.value = s.uid;
        option.textContent = s.name;
        if (preselectedId && s.uid === preselectedId) {
          option.selected = true;
        }
        select.appendChild(option);
      });

      sessionStorage.removeItem('preselectedStudentId');

      select.addEventListener('change', updatePreview);
      
      if (preselectedId) {
        updatePreview();
      }
    } catch (error) {
      console.error('Erro ao carregar alunos:', error);
    }
  }

  // Carregar exercícios
  async function loadExercises() {
    try {
      const exercises = await dbManager.getPersonalExercises();
      const container = document.getElementById('availableExercises');
      document.getElementById('exercisesCount').textContent = exercises.length;

      exercises.forEach(ex => { state.exercisesMap[ex.id] = ex; });

      if (exercises.length === 0) {
        container.innerHTML = `
          <div class="empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="margin: 0 auto 15px; display: block;">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6"></path>
            </svg>
            <p>Nenhum exercício disponível.</p>
            <p style="font-size: 13px;"><a href="#/personal/exercises">Criar exercício primeiro</a></p>
          </div>
        `;
      } else {
        container.innerHTML = exercises.map(ex => `
          <div class="exercise-item">
            <div style="flex: 1;">
              <h4>${ex.name}</h4>
              <p>${ex.description || 'Sem descrição'}</p>
            </div>
            <button class="btn-secondary add-exercise-btn" data-exercise-id="${ex.id}">+ Adicionar</button>
          </div>
        `).join('');

        document.querySelectorAll('.add-exercise-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            addExercise(btn.dataset.exerciseId);
          });
        });
      }
    } catch (error) {
      console.error('Erro ao carregar exercícios:', error);
    }
  }

  // Adicionar exercício (ATUALIZADO - adicionado campo "carga")
  function addExercise(exerciseId) {
    if (!state.selectedDay) {
      alert('⚠️ Selecione um dia primeiro!');
      return;
    }

    const exercise = state.exercisesMap[exerciseId];
    if (!exercise) {
      alert('❌ Exercício não encontrado');
      return;
    }

    const sets = prompt('Quantas séries?', '3');
    if (sets === null) return;

    const reps = prompt('Quantas repetições?', '10');
    if (reps === null) return;

    const weight = prompt('Qual a carga? (Ex: 20kg, Peso corporal, etc)', '');
    if (weight === null) return;

    const notes = prompt('Observações (opcional):', '');

    state.dayExercises[state.selectedDay].push({
      exerciseId: exerciseId,
      exerciseName: exercise.name,
      videoUrl: exercise.videoUrl || '',
      sets: sets,
      reps: reps,
      weight: weight || '',
      notes: notes || ''
    });

    alert('✓ Exercício adicionado ao ' + DAYS_MAP[state.selectedDay]);
    updatePreview();
  }

  // Atualizar preview (ATUALIZADO - exibe campo "carga")
  function updatePreview() {
    const preview = document.getElementById('workoutPreview');
    const name = document.getElementById('workoutName').value || 'Sem nome';
    const desc = document.getElementById('workoutDescription').value;
    const studentSelect = document.getElementById('studentSelect');
    const studentName = studentSelect.value ? studentSelect.options[studentSelect.selectedIndex].text : null;

    let html = `<h3>${name}</h3>`;
    if (desc) html += `<p style="color: #666; margin-bottom: 15px; font-size: 14px;">${desc}</p>`;
    if (studentName) html += `<p style="color: #666; margin-bottom: 15px; font-size: 14px;"><strong>Aluno:</strong> ${studentName}</p>`;

    let hasContent = false;

    DAYS_ORDER.forEach(day => {
      if (state.dayExercises[day].length > 0) {
        hasContent = true;
        html += '<div class="preview-day">';
        html += `<strong>${DAYS_MAP[day]}</strong>`;
        html += '<ul>';
        state.dayExercises[day].forEach((ex, idx) => {
          html += `<li>${ex.exerciseName} - ${ex.sets}x${ex.reps}`;
          if (ex.weight) html += ` <small style="color: #666;">(${ex.weight})</small>`;
          if (ex.notes) html += ` <small style="color: #666; font-style: italic;">(${ex.notes})</small>`;
          html += ` <button onclick="removeExercise('${day}', ${idx})" style="background: #cc0000; color: #fff; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 5px;">✕</button>`;
          html += '</li>';
        });
        html += '</ul>';
        html += '</div>';
      }
    });

    if (!hasContent) {
      html += '<p class="empty">Selecione os dias e adicione exercícios...</p>';
    }

    preview.innerHTML = html;
  }

  // Remover exercício
  window.removeExercise = function(day, index) {
    if (confirm('Remover este exercício?')) {
      state.dayExercises[day].splice(index, 1);
      updatePreview();
    }
  };

  // Seleção de dias
  document.querySelectorAll('.day-box').forEach(box => {
    box.addEventListener('click', () => {
      const day = box.dataset.day;
      
      document.querySelectorAll('.day-box').forEach(b => b.classList.remove('selected'));
      
      box.classList.add('selected');
      state.selectedDay = day;
      
      const info = document.getElementById('selectedDayInfo');
      const dayName = document.getElementById('selectedDayName');
      info.style.display = 'block';
      dayName.textContent = DAYS_MAP[day];
    });
  });

  // Salvar treino
  async function saveWorkout() {
    const name = document.getElementById('workoutName').value.trim();
    const description = document.getElementById('workoutDescription').value.trim();
    const studentId = document.getElementById('studentSelect').value;
    const errorDiv = document.getElementById('createError');
    const successDiv = document.getElementById('createSuccess');
    const saveBtn = document.getElementById('saveWorkoutBtn');

    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    if (!name) {
      errorDiv.textContent = '❌ Nome do treino é obrigatório';
      errorDiv.style.display = 'block';
      return;
    }

    if (!studentId) {
      errorDiv.textContent = '❌ Selecione um aluno';
      errorDiv.style.display = 'block';
      return;
    }

    let hasExercises = false;
    DAYS_ORDER.forEach(day => {
      if (state.dayExercises[day].length > 0) {
        hasExercises = true;
      }
    });

    if (!hasExercises) {
      errorDiv.textContent = '❌ Adicione pelo menos um exercício em algum dia';
      errorDiv.style.display = 'block';
      return;
    }

    const daysData = {};
    DAYS_ORDER.forEach(day => {
      if (state.dayExercises[day].length > 0) {
        daysData[day] = state.dayExercises[day];
      }
    });

    saveBtn.disabled = true;
    saveBtn.textContent = '⏳ Salvando...';

    try {
      const result = await dbManager.createWorkout(name, description, daysData, studentId);

      if (result.success) {
        successDiv.innerHTML = '✓ <strong>Treino salvo com sucesso!</strong><br><small>Redirecionando...</small>';
        successDiv.style.display = 'block';
        
        setTimeout(() => {
          router.goToStudentDetails(studentId);
        }, 1500);
      } else {
        errorDiv.textContent = '❌ ' + result.error;
        errorDiv.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Salvar Treino';
      }
    } catch (error) {
      errorDiv.textContent = '❌ Erro: ' + error.message;
      errorDiv.style.display = 'block';
      saveBtn.disabled = false;
      saveBtn.textContent = 'Salvar Treino';
    }
  }

  // Event listeners
  document.getElementById('workoutName').addEventListener('input', updatePreview);
  document.getElementById('workoutDescription').addEventListener('input', updatePreview);

  document.getElementById('clearSelectionBtn').addEventListener('click', () => {
    if (!confirm('Limpar tudo e recomeçar?')) return;
    
    DAYS_ORDER.forEach(day => {
      state.dayExercises[day] = [];
    });
    
    state.selectedDay = null;
    document.getElementById('workoutName').value = '';
    document.getElementById('workoutDescription').value = '';
    document.querySelectorAll('.day-box').forEach(box => box.classList.remove('selected'));
    document.getElementById('selectedDayInfo').style.display = 'none';
    
    updatePreview();
  });

  document.getElementById('saveWorkoutBtn').addEventListener('click', saveWorkout);

  // Carregar tudo
  await loadStudents();
  await loadExercises();

  document.getElementById('pageLoading').style.display = 'none';
  document.getElementById('mainContent').style.display = 'block';

  updatePreview();

  console.log('=== PÁGINA TOTALMENTE CARREGADA ===');
})();
</script>