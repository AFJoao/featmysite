<div class="create-workout-page">
  <header>
    <h1>Criar Treino</h1>
    <nav>
      <a href="#/personal/dashboard">Dashboard</a>
      <a href="#/personal/exercises">Exercícios</a>
      <a href="#" id="logoutBtn">Sair</a>
    </nav>
  </header>

  <!-- Loading inicial -->
  <div id="pageLoading" style="text-align: center; padding: 50px;">
    <div class="spinner" style="margin: 0 auto;"></div>
    <p>Carregando dados...</p>
  </div>

  <!-- Conteúdo principal (oculto inicialmente) -->
  <div id="mainContent" style="display: none; max-width: 1200px; margin: 30px auto;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <!-- Coluna Esquerda: Formulário -->
      <div>
        <h2>Informações do Treino</h2>
        
        <div id="createError" class="alert error" style="display: none;"></div>
        <div id="createSuccess" class="alert success" style="display: none;"></div>

        <div class="form-group">
          <label for="workoutName">Nome do Treino:</label>
          <input type="text" id="workoutName" placeholder="Ex: Treino A - Peito" required>
        </div>

        <div class="form-group">
          <label for="workoutDescription">Descrição:</label>
          <textarea id="workoutDescription" placeholder="Descreva o treino..."></textarea>
        </div>

        <div class="form-group">
          <label for="studentSelect">Associar a Aluno:</label>
          <select id="studentSelect">
            <option value="">-- Selecione um aluno (opcional) --</option>
          </select>
        </div>

        <h3 style="margin-top: 20px;">Selecione os Dias</h3>
        <div class="days-grid" id="daysGrid">
          <div class="day-box" data-day="monday">Segunda</div>
          <div class="day-box" data-day="tuesday">Terça</div>
          <div class="day-box" data-day="wednesday">Quarta</div>
          <div class="day-box" data-day="thursday">Quinta</div>
          <div class="day-box" data-day="friday">Sexta</div>
          <div class="day-box" data-day="saturday">Sábado</div>
          <div class="day-box" data-day="sunday">Domingo</div>
        </div>

        <h3 style="margin-top: 20px;">Exercícios Disponíveis (<span id="exercisesCount">0</span>)</h3>
        <div id="availableExercises" class="exercises-list"></div>

        <button id="clearSelectionBtn" class="secondary" style="margin-top: 20px; width: 100%;">Limpar Seleção</button>
        <button id="saveWorkoutBtn" style="margin-top: 10px; width: 100%;">Salvar Treino</button>
      </div>

      <!-- Coluna Direita: Visualização -->
      <div>
        <h2>Visualização do Treino</h2>
        <div id="workoutPreview" style="border: 2px solid #000000; padding: 15px; min-height: 400px;">
          <p style="color: #999;">A visualização aparecerá aqui...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(async function() {
  console.log('=== PÁGINA CRIAR TREINO - INICIANDO ===');

  // Estado global
  const workoutState = {
    name: '',
    description: '',
    studentId: '',
    selectedDays: {},
    dayExercises: {},
    exercisesMap: {}
  };

  // Inicializar dias
  const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
  const dayNames = {
    monday: 'Segunda-feira',
    tuesday: 'Terça-feira',
    wednesday: 'Quarta-feira',
    thursday: 'Quinta-feira',
    friday: 'Sexta-feira',
    saturday: 'Sábado',
    sunday: 'Domingo'
  };

  days.forEach(day => {
    workoutState.selectedDays[day] = false;
    workoutState.dayExercises[day] = [];
  });

  // Aguardar DOM
  await new Promise(resolve => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });

  await new Promise(resolve => setTimeout(resolve, 100));

  console.log('✓ DOM pronto');

  // Carregar alunos
  async function loadStudents() {
    try {
      console.log('Carregando alunos...');
      const students = await dbManager.getAllStudents();
      console.log('Alunos carregados:', students.length);
      
      const select = document.getElementById('studentSelect');
      if (!select) return;
      
      students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.uid;
        option.textContent = student.name;
        select.appendChild(option);
      });

      select.addEventListener('change', (e) => {
        workoutState.studentId = e.target.value;
        updatePreview();
      });

      console.log('✓ Alunos carregados');
    } catch (error) {
      console.error('Erro ao carregar alunos:', error);
    }
  }

  // Carregar exercícios
  async function loadExercises() {
    try {
      console.log('=== CARREGANDO EXERCÍCIOS ===');
      const exercises = await dbManager.getPersonalExercises();
      console.log('Exercícios retornados:', exercises.length);
      
      const container = document.getElementById('availableExercises');
      const countSpan = document.getElementById('exercisesCount');

      if (!container || !countSpan) return;

      countSpan.textContent = exercises.length;

      if (exercises.length === 0) {
        container.innerHTML = `
          <div class="card" style="background-color: #f5f5f5;">
            <p style="margin: 0; color: #666;">
              ⚠️ Nenhum exercício disponível.<br>
              <a href="#/personal/exercises" style="font-weight: bold;">Criar exercício primeiro</a>
            </p>
          </div>
        `;
      } else {
        // Armazenar exercícios no mapa
        exercises.forEach(ex => {
          workoutState.exercisesMap[ex.id] = ex;
        });

        container.innerHTML = exercises.map(exercise => `
          <div class="exercise-item" style="margin: 10px 0; padding: 15px; border: 1px solid #000;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 5px 0;">${exercise.name}</h4>
                <p style="margin: 0; font-size: 12px; color: #666;">${exercise.description || 'Sem descrição'}</p>
              </div>
              <button 
                data-exercise-id="${exercise.id}" 
                class="add-exercise-btn secondary"
                style="padding: 8px 15px; white-space: nowrap;">
                + Adicionar
              </button>
            </div>
          </div>
        `).join('');

        // Adicionar event listeners
        document.querySelectorAll('.add-exercise-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const exerciseId = btn.getAttribute('data-exercise-id');
            addExerciseToDay(exerciseId);
          });
        });

        console.log('✓ Exercícios renderizados');
      }
    } catch (error) {
      console.error('❌ Erro ao carregar exercícios:', error);
      const container = document.getElementById('availableExercises');
      if (container) {
        container.innerHTML = `
          <div class="card" style="border-color: #cc0000;">
            <p style="color: #cc0000;">
              <strong>❌ Erro ao carregar exercícios.</strong><br>
              ${error.message}
            </p>
          </div>
        `;
      }
    }
  }

  // Adicionar exercício ao dia
  function addExerciseToDay(exerciseId) {
    console.log('Adicionando exercício:', exerciseId);

    const selectedDay = Object.keys(workoutState.selectedDays).find(day => workoutState.selectedDays[day]);
    
    if (!selectedDay) {
      alert('⚠️ Selecione um dia primeiro!\n\nClique em um dos dias da semana antes de adicionar exercícios.');
      return;
    }

    const exercise = workoutState.exercisesMap[exerciseId];
    if (!exercise) {
      alert('❌ Erro: exercício não encontrado');
      return;
    }

    const sets = prompt('Quantas séries?', '3');
    if (sets === null) return;

    const reps = prompt('Quantas repetições?', '10');
    if (reps === null) return;

    const notes = prompt('Observações (opcional):', '');

    workoutState.dayExercises[selectedDay].push({
      exerciseId: exerciseId,
      exerciseName: exercise.name,
      videoUrl: exercise.videoUrl || '',
      sets: sets,
      reps: reps,
      notes: notes || ''
    });

    alert('✓ Exercício adicionado!');
    updatePreview();
  }

  // Atualizar preview
  function updatePreview() {
    const preview = document.getElementById('workoutPreview');
    if (!preview) return;

    let html = '<h3>' + (document.getElementById('workoutName')?.value || 'Sem nome') + '</h3>';
    
    const descValue = document.getElementById('workoutDescription')?.value;
    if (descValue) {
      html += '<p><strong>Descrição:</strong> ' + descValue + '</p>';
    }

    const studentSelect = document.getElementById('studentSelect');
    if (studentSelect?.value) {
      const studentName = studentSelect.options[studentSelect.selectedIndex].text;
      html += '<p><strong>Aluno:</strong> ' + studentName + '</p>';
    }

    html += '<h4 style="margin-top: 15px;">Dias e Exercícios:</h4>';

    let hasContent = false;

    days.forEach(day => {
      if (workoutState.selectedDays[day]) {
        hasContent = true;
        html += '<div style="margin: 10px 0; padding: 10px; border-left: 3px solid #000; background: #f9f9f9;">';
        html += '<strong>' + dayNames[day] + '</strong>';
        
        if (workoutState.dayExercises[day].length === 0) {
          html += '<p style="margin: 5px 0; font-size: 12px; color: #999;">Nenhum exercício</p>';
        } else {
          html += '<ul style="margin: 5px 0; padding-left: 20px;">';
          workoutState.dayExercises[day].forEach((ex, idx) => {
            html += '<li style="margin: 5px 0;">';
            html += ex.exerciseName + ' - ' + ex.sets + 'x' + ex.reps;
            if (ex.notes) html += ' <small>(' + ex.notes + ')</small>';
            html += ' <button class="remove-exercise-btn danger" data-day="' + day + '" data-index="' + idx + '" style="padding: 2px 8px; font-size: 10px; margin-left: 5px;">✕</button>';
            html += '</li>';
          });
          html += '</ul>';
        }
        html += '</div>';
      }
    });

    if (!hasContent) {
      html += '<p style="color: #999; font-style: italic;">Selecione os dias e adicione exercícios...</p>';
    }

    preview.innerHTML = html;
    
    // Event listeners para botões de remover
    document.querySelectorAll('.remove-exercise-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const day = btn.getAttribute('data-day');
        const index = parseInt(btn.getAttribute('data-index'));
        workoutState.dayExercises[day].splice(index, 1);
        updatePreview();
      });
    });
  }

  // Salvar treino
  async function saveWorkout() {
    console.log('=== SALVANDO TREINO ===');
    
    const name = document.getElementById('workoutName')?.value.trim();
    const description = document.getElementById('workoutDescription')?.value.trim();
    const errorDiv = document.getElementById('createError');
    const successDiv = document.getElementById('createSuccess');
    const saveBtn = document.getElementById('saveWorkoutBtn');

    if (!errorDiv || !successDiv || !saveBtn) return;

    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    if (!name) {
      errorDiv.textContent = '❌ Nome do treino é obrigatório';
      errorDiv.style.display = 'block';
      return;
    }

    const hasDays = Object.values(workoutState.selectedDays).some(v => v);
    if (!hasDays) {
      errorDiv.textContent = '❌ Selecione pelo menos um dia';
      errorDiv.style.display = 'block';
      return;
    }

    let hasExercises = false;
    days.forEach(day => {
      if (workoutState.selectedDays[day] && workoutState.dayExercises[day].length > 0) {
        hasExercises = true;
      }
    });

    if (!hasExercises) {
      errorDiv.textContent = '❌ Adicione pelo menos um exercício';
      errorDiv.style.display = 'block';
      return;
    }

    const daysData = {};
    days.forEach(day => {
      if (workoutState.selectedDays[day]) {
        daysData[day] = workoutState.dayExercises[day];
      }
    });

    saveBtn.disabled = true;
    saveBtn.textContent = '⏳ Salvando...';

    try {
      const result = await dbManager.createWorkout(
        name,
        description || '',
        daysData,
        document.getElementById('studentSelect')?.value || null
      );

      console.log('Resultado:', result);

      if (result.success) {
        successDiv.innerHTML = '✓ <strong>Treino salvo!</strong><br><small>Redirecionando...</small>';
        successDiv.style.display = 'block';
        
        setTimeout(() => {
          router.goToPersonalDashboard();
        }, 1500);
      } else {
        errorDiv.textContent = '❌ ' + result.error;
        errorDiv.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Salvar Treino';
      }
    } catch (error) {
      console.error('Erro ao salvar:', error);
      errorDiv.textContent = '❌ Erro: ' + error.message;
      errorDiv.style.display = 'block';
      saveBtn.disabled = false;
      saveBtn.textContent = 'Salvar Treino';
    }
  }

  // CARREGAR TUDO ANTES DE MOSTRAR
  console.log('Carregando dados...');
  
  await loadStudents();
  await loadExercises();
  
  console.log('✓ Dados carregados');

  // Configurar event listeners
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await authManager.logout();
      router.goToLogin();
    });
  }

  // Dias
  document.querySelectorAll('.day-box').forEach(box => {
    box.addEventListener('click', () => {
      const day = box.dataset.day;
      workoutState.selectedDays[day] = !workoutState.selectedDays[day];
      box.classList.toggle('selected');
      updatePreview();
    });
  });

  // Botões
  document.getElementById('workoutName')?.addEventListener('input', updatePreview);
  document.getElementById('workoutDescription')?.addEventListener('input', updatePreview);
  document.getElementById('clearSelectionBtn')?.addEventListener('click', () => {
    if (!confirm('Limpar tudo?')) return;
    
    days.forEach(day => {
      workoutState.selectedDays[day] = false;
      workoutState.dayExercises[day] = [];
    });
    
    document.getElementById('workoutName').value = '';
    document.getElementById('workoutDescription').value = '';
    document.getElementById('studentSelect').value = '';
    document.querySelectorAll('.day-box').forEach(box => box.classList.remove('selected'));
    
    updatePreview();
  });
  document.getElementById('saveWorkoutBtn')?.addEventListener('click', saveWorkout);

  updatePreview();

  // MOSTRAR CONTEÚDO
  document.getElementById('pageLoading').style.display = 'none';
  document.getElementById('mainContent').style.display = 'block';
  
  console.log('=== PÁGINA TOTALMENTE CARREGADA ===');
})();
</script>