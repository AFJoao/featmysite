<div class="personal-feedbacks">
  <link rel="stylesheet" href="css/mobile-responsive-fixes.css">
  <header style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <button onclick="router.goToPersonalDashboard()" style="background: rgba(255,255,255,0.1); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.borderColor='#ffffff';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.3)';">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <h1 style="color: #ffffff; font-size: 24px; font-weight: 600; margin: 0;">Feedbacks dos Alunos</h1>
      </div>
      <button id="logoutBtn" style="background: transparent; color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Sair
      </button>
    </div>
  </header>

  <div style="max-width: 1400px; margin: 0 auto; padding: 30px 20px;">
    <!-- Filtros -->
    <div style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
      <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: #000000;">Filtros</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">Aluno</label>
          <select id="filterStudent" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box;">
            <option value="">Todos os alunos</option>
          </select>
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">Semana</label>
          <input type="text" id="filterWeek" placeholder="Ex: 2024-15" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box;">
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">Dia da Semana</label>
          <select id="filterDay" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box;">
            <option value="">Todos os dias</option>
            <option value="monday">Segunda-feira</option>
            <option value="tuesday">Terça-feira</option>
            <option value="wednesday">Quarta-feira</option>
            <option value="thursday">Quinta-feira</option>
            <option value="friday">Sexta-feira</option>
            <option value="saturday">Sábado</option>
            <option value="sunday">Domingo</option>
          </select>
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">Sensação</label>
          <select id="filterSensation" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box;">
            <option value="">Todas</option>
            <option value="leve">Leve</option>
            <option value="ideal">Ideal</option>
            <option value="pesado">Pesado</option>
          </select>
        </div>
      </div>
      <button id="clearFilters" style="margin-top: 15px; padding: 10px 20px; background: transparent; color: #666; border: 1px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">Limpar Filtros</button>
    </div>

    <!-- Lista de Feedbacks -->
    <div id="feedbacksList" style="display: flex; flex-direction: column; gap: 20px;">
      <div style="text-align: center; padding: 60px 20px;">
        <div class="spinner" style="margin: 0 auto 20px;"></div>
        <p style="color: #999;">Carregando feedbacks...</p>
      </div>
    </div>
  </div>
</div>

<script>
(async function() {
  const daysMap = {
    monday: 'Segunda-feira',
    tuesday: 'Terça-feira',
    wednesday: 'Quarta-feira',
    thursday: 'Quinta-feira',
    friday: 'Sexta-feira',
    saturday: 'Sábado',
    sunday: 'Domingo'
  };

  const sensationMap = {
    leve: 'Leve',
    ideal: 'Ideal',
    pesado: 'Pesado'
  };

  await new Promise(resolve => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });

  await new Promise(resolve => setTimeout(resolve, 100));

  let allFeedbacks = [];
  let allStudents = [];
  let allWorkouts = {};

  // Logout
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      await authManager.logout();
      router.goToLogin();
    });
  }

  // Carregar dados iniciais
  async function loadInitialData() {
    allStudents = await dbManager.getMyStudents();
    allFeedbacks = await dbManager.getPersonalFeedbacks();

    // Carregar treinos
    for (const feedback of allFeedbacks) {
      if (!allWorkouts[feedback.workoutId]) {
        const workout = await dbManager.getWorkout(feedback.workoutId);
        if (workout) {
          allWorkouts[feedback.workoutId] = workout;
        }
      }
    }

    // Popular select de alunos
    const filterStudent = document.getElementById('filterStudent');
    if (filterStudent) {
      allStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.uid;
        option.textContent = student.name;
        filterStudent.appendChild(option);
      });
    }

    renderFeedbacks();
  }

  // Renderizar feedbacks
  function renderFeedbacks() {
    const container = document.getElementById('feedbacksList');
    if (!container) return;

    // Aplicar filtros
    let filtered = [...allFeedbacks];

    const filterStudent = document.getElementById('filterStudent')?.value;
    const filterWeek = document.getElementById('filterWeek')?.value;
    const filterDay = document.getElementById('filterDay')?.value;
    const filterSensation = document.getElementById('filterSensation')?.value;

    if (filterStudent) {
      filtered = filtered.filter(f => f.studentId === filterStudent);
    }

    if (filterWeek) {
      filtered = filtered.filter(f => f.weekIdentifier === filterWeek);
    }

    if (filterDay) {
      filtered = filtered.filter(f => f.dayOfWeek === filterDay);
    }

    if (filterSensation) {
      filtered = filtered.filter(f => f.sensation === filterSensation);
    }

    if (filtered.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; background: #f8f8f8; border-radius: 12px; border: 2px dashed #ddd;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="margin: 0 auto 20px; display: block;">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <p style="color: #666; font-size: 18px; margin: 0;">Nenhum feedback encontrado</p>
        </div>
      `;
      return;
    }

    let html = '';
    filtered.forEach(feedback => {
      const student = allStudents.find(s => s.uid === feedback.studentId);
      const workout = allWorkouts[feedback.workoutId];
      const studentName = student?.name || 'Aluno desconhecido';
      const workoutName = workout?.name || 'Treino não encontrado';

      // Formatar data
      let dateStr = 'Data não disponível';
      if (feedback.createdAt) {
        const date = feedback.createdAt.toDate ? feedback.createdAt.toDate() : new Date(feedback.createdAt.seconds * 1000);
        dateStr = date.toLocaleDateString('pt-BR', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      const sensationColor = {
        leve: '#22c55e',
        ideal: '#3b82f6',
        pesado: '#ef4444'
      }[feedback.sensation] || '#666';

      html += `
        <div style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <div style="flex: 1; min-width: 200px;">
              <h3 style="font-size: 20px; font-weight: 600; margin: 0 0 8px 0; color: #000000;">${studentName}</h3>
              <p style="font-size: 14px; color: #666; margin: 0 0 4px 0;">${workoutName}</p>
              <p style="font-size: 12px; color: #999; margin: 0;">${dateStr}</p>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <div style="padding: 8px 16px; background: #f8f8f8; border-radius: 8px;">
                <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 4px;">SEMANA</div>
                <div style="font-size: 14px; font-weight: 700; color: #000000;">${feedback.weekIdentifier}</div>
              </div>
              <div style="padding: 8px 16px; background: #f8f8f8; border-radius: 8px;">
                <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 4px;">DIA</div>
                <div style="font-size: 14px; font-weight: 700; color: #000000;">${daysMap[feedback.dayOfWeek] || feedback.dayOfWeek}</div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="padding: 15px; background: #f8f8f8; border-radius: 8px;">
              <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Esforço</div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #000000;">${feedback.effortLevel}</div>
                <div style="font-size: 12px; color: #999;">/ 10</div>
              </div>
            </div>
            <div style="padding: 15px; background: #f8f8f8; border-radius: 8px;">
              <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Sensação</div>
              <div style="font-size: 16px; font-weight: 700; color: ${sensationColor};">${sensationMap[feedback.sensation] || feedback.sensation}</div>
            </div>
            <div style="padding: 15px; background: #f8f8f8; border-radius: 8px;">
              <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Dor</div>
              <div style="font-size: 16px; font-weight: 700; color: ${feedback.hasPain ? '#ef4444' : '#22c55e'};">${feedback.hasPain ? 'Sim' : 'Não'}</div>
            </div>
          </div>

          ${feedback.hasPain && feedback.painLocation ? `
            <div style="padding: 15px; background: #fff3f3; border-left: 4px solid #ef4444; border-radius: 8px; margin-bottom: 15px;">
              <div style="font-size: 12px; font-weight: 600; color: #ef4444; margin-bottom: 6px; text-transform: uppercase;">Local da Dor</div>
              <div style="font-size: 14px; color: #666;">${feedback.painLocation}</div>
            </div>
          ` : ''}

          ${feedback.comment ? `
            <div style="padding: 15px; background: #f8f8f8; border-radius: 8px;">
              <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px; text-transform: uppercase;">Comentário</div>
              <div style="font-size: 14px; color: #333; line-height: 1.6;">${feedback.comment}</div>
            </div>
          ` : ''}
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // Aplicar filtros
  const filterInputs = ['filterStudent', 'filterWeek', 'filterDay', 'filterSensation'];
  filterInputs.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('change', renderFeedbacks);
      element.addEventListener('input', renderFeedbacks);
    }
  });

  // Limpar filtros
  const clearFilters = document.getElementById('clearFilters');
  if (clearFilters) {
    clearFilters.addEventListener('click', () => {
      document.getElementById('filterStudent').value = '';
      document.getElementById('filterWeek').value = '';
      document.getElementById('filterDay').value = '';
      document.getElementById('filterSensation').value = '';
      renderFeedbacks();
    });
  }

  await loadInitialData();
})();
</script>

<style>
.spinner {
  width: 32px;
  height: 32px;
  border: 4px solid #ddd;
  border-top-color: #000;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

