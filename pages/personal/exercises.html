<div class="exercises-page">
  <header style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <a href="#/personal/dashboard" style="background: rgba(255,255,255,0.1); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px; border-radius: 6px; text-decoration: none; display: flex; align-items: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.borderColor='#ffffff';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.3)';">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </a>
        <h1 style="color: #ffffff; font-size: 24px; font-weight: 600; margin: 0;">Gerenciar Exercícios</h1>
      </div>
      <button id="logoutBtn" style="background: transparent; color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Sair
      </button>
    </div>
  </header>

  <div style="max-width: 1400px; margin: 0 auto; padding: 30px 20px;">
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
      
      <!-- Formulário de Criar Exercício -->
      <div>
        <div style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: sticky; top: 20px;">
          <h2 style="font-size: 22px; font-weight: 600; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Novo Exercício
          </h2>
          
          <div id="createError" class="alert error" style="display: none;"></div>
          <div id="createSuccess" class="alert success" style="display: none;"></div>

          <div class="form-group">
            <label for="exerciseName">Nome do Exercício:</label>
            <input type="text" id="exerciseName" placeholder="Ex: Supino Reto" required style="width: 100%; padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#000000'; this.style.boxShadow='0 0 0 3px rgba(0,0,0,0.05)';" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none';">
          </div>

          <div class="form-group">
            <label for="exerciseDescription">Descrição:</label>
            <textarea id="exerciseDescription" placeholder="Descreva o exercício, músculos trabalhados, etc." style="width: 100%; padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px; min-height: 100px; transition: all 0.3s; resize: vertical;" onfocus="this.style.borderColor='#000000'; this.style.boxShadow='0 0 0 3px rgba(0,0,0,0.05)';" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none';"></textarea>
          </div>

          <div class="form-group">
            <label for="exerciseVideo">URL do Vídeo (YouTube):</label>
            <input type="text" id="exerciseVideo" placeholder="Cole o link do YouTube" style="width: 100%; padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#000000'; this.style.boxShadow='0 0 0 3px rgba(0,0,0,0.05)';" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none';">
            <small style="display: block; margin-top: 8px; color: #666; font-size: 13px; line-height: 1.5;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              Cole qualquer link do YouTube - será convertido automaticamente
            </small>
            <div id="videoPreview" style="margin-top: 15px; display: none;"></div>
          </div>

          <button id="createExerciseBtn" type="button" style="width: 100%; background: #000000; color: #ffffff; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Criar Exercício
          </button>
        </div>
      </div>

      <!-- Lista de Exercícios -->
      <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="font-size: 24px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 10px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6"></path>
              <path d="m4.93 4.93 4.24 4.24m5.66 5.66 4.24 4.24"></path>
              <path d="m19.07 4.93-4.24 4.24m-5.66 5.66-4.24 4.24"></path>
            </svg>
            Biblioteca de Exercícios
            <span id="exercisesCount" style="background: #000000; color: #ffffff; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">0</span>
          </h2>
        </div>

        <div id="exercisesList">
          <div style="text-align: center; padding: 60px 20px;">
            <div class="spinner" style="margin: 0 auto 20px;"></div>
            <p style="color: #999; font-size: 16px; margin: 0;">Carregando exercícios...</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(async function() {
  await new Promise(resolve => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });

  await new Promise(resolve => setTimeout(resolve, 100));

  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('mouseover', () => {
      logoutBtn.style.background = 'rgba(255,255,255,0.1)';
      logoutBtn.style.borderColor = '#ffffff';
    });
    logoutBtn.addEventListener('mouseout', () => {
      logoutBtn.style.background = 'transparent';
      logoutBtn.style.borderColor = 'rgba(255,255,255,0.3)';
    });
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await authManager.logout();
      router.goToLogin();
    });
  }

  const videoInput = document.getElementById('exerciseVideo');
  const videoPreview = document.getElementById('videoPreview');

  if (videoInput) {
    videoInput.addEventListener('input', (e) => {
      const url = e.target.value.trim();
      
      if (url === '') {
        videoPreview.style.display = 'none';
        return;
      }

      const embedUrl = dbManager.convertYouTubeUrl(url);
      
      if (embedUrl && embedUrl.includes('/embed/')) {
        videoPreview.style.display = 'block';
        videoPreview.innerHTML = `
          <div style="border: 2px solid #e0e0e0; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="background: #f8f8f8; padding: 10px 15px; border-bottom: 1px solid #e0e0e0;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span style="font-size: 13px; font-weight: 600; color: #22c55e;">Vídeo válido</span>
              </div>
            </div>
            <div style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0;">
              <iframe 
                src="${embedUrl}" 
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                allowfullscreen>
              </iframe>
            </div>
          </div>
        `;
      } else {
        videoPreview.style.display = 'none';
      }
    });
  }

  const createExerciseBtn = document.getElementById('createExerciseBtn');
  if (createExerciseBtn) {
    createExerciseBtn.addEventListener('click', async () => {
      const name = document.getElementById('exerciseName')?.value.trim();
      const description = document.getElementById('exerciseDescription')?.value.trim();
      const videoUrl = document.getElementById('exerciseVideo')?.value.trim();
      const errorDiv = document.getElementById('createError');
      const successDiv = document.getElementById('createSuccess');

      if (!errorDiv || !successDiv) return;

      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      if (!name) {
        errorDiv.textContent = '❌ Nome do exercício é obrigatório';
        errorDiv.style.display = 'block';
        return;
      }

      createExerciseBtn.textContent = '⏳ Criando...';
      createExerciseBtn.disabled = true;

      try {
        const result = await dbManager.createExercise(name, description || '', videoUrl || '');

        if (result.success) {
          successDiv.innerHTML = '✓ <strong>Exercício criado!</strong>';
          successDiv.style.display = 'block';
          
          document.getElementById('exerciseName').value = '';
          document.getElementById('exerciseDescription').value = '';
          document.getElementById('exerciseVideo').value = '';
          videoPreview.style.display = 'none';

          setTimeout(async () => {
            successDiv.style.display = 'none';
            await loadExercises();
            createExerciseBtn.innerHTML = `
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Criar Exercício
            `;
            createExerciseBtn.disabled = false;
          }, 1500);
        } else {
          errorDiv.textContent = '❌ ' + result.error;
          errorDiv.style.display = 'block';
          createExerciseBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Criar Exercício
          `;
          createExerciseBtn.disabled = false;
        }
      } catch (error) {
        console.error('Erro:', error);
        errorDiv.textContent = '❌ Erro: ' + error.message;
        errorDiv.style.display = 'block';
        createExerciseBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Criar Exercício
        `;
        createExerciseBtn.disabled = false;
      }
    });
  }

  async function loadExercises() {
    try {
      const exercisesList = document.getElementById('exercisesList');
      const exercisesCount = document.getElementById('exercisesCount');

      if (!exercisesList || !exercisesCount) return;

      const exercises = await dbManager.getPersonalExercises();

      exercisesCount.textContent = exercises.length;

      if (exercises.length === 0) {
        exercisesList.innerHTML = `
          <div style="text-align: center; padding: 80px 40px; background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%); border-radius: 12px; border: 2px dashed #ddd;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="margin: 0 auto 20px; display: block;">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6"></path>
              <path d="m4.93 4.93 4.24 4.24m5.66 5.66 4.24 4.24"></path>
              <path d="m19.07 4.93-4.24 4.24m-5.66 5.66-4.24 4.24"></path>
            </svg>
            <h3 style="font-size: 20px; font-weight: 600; color: #666; margin: 0 0 10px 0;">Nenhum exercício criado</h3>
            <p style="color: #999; font-size: 15px; margin: 0;">Crie seu primeiro exercício usando o formulário ao lado</p>
          </div>
        `;
      } else {
        exercisesList.innerHTML = `
          <div style="display: grid; gap: 20px;">
            ${exercises.map(exercise => {
              const hasVideo = exercise.videoUrl && exercise.videoUrl.trim() !== '';
              
              return `
                <div style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.03); transition: all 0.3s;" onmouseover="this.style.borderColor='#000000'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';" onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.03)';">
                  
                  ${hasVideo ? `
                    <div style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; background: #000000;">
                      <iframe 
                        src="${exercise.videoUrl}" 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                        allowfullscreen>
                      </iframe>
                    </div>
                  ` : `
                    <div style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%); display: flex; align-items: center; justify-content: center;">
                      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2" style="margin: 0 auto 10px; display: block;">
                          <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <p style="color: #999; font-size: 13px; margin: 0;">Sem vídeo</p>
                      </div>
                    </div>
                  `}

                  <div style="padding: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 10px 0; color: #000000;">${exercise.name}</h3>
                    ${exercise.description ? `<p style="color: #666; font-size: 14px; margin: 0 0 15px 0; line-height: 1.6;">${exercise.description}</p>` : ''}
                    
                    <button 
                      data-exercise-id="${exercise.id}" 
                      class="delete-exercise-btn"
                      style="width: 100%; background: #ffffff; color: #cc0000; border: 1px solid #cc0000; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;"
                      onmouseover="this.style.background='#cc0000'; this.style.color='#ffffff';"
                      onmouseout="this.style.background='#ffffff'; this.style.color='#cc0000';">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                      Deletar Exercício
                    </button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;

        document.querySelectorAll('.delete-exercise-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const exerciseId = btn.getAttribute('data-exercise-id');
            
            if (confirm('⚠️ Tem certeza que deseja deletar este exercício?\n\nEsta ação não pode ser desfeita.')) {
              try {
                const result = await dbManager.deleteExercise(exerciseId);
                if (result.success) {
                  alert('✓ Exercício deletado!');
                  loadExercises();
                } else {
                  alert('❌ Erro: ' + result.error);
                }
              } catch (error) {
                console.error('Erro:', error);
                alert('❌ Erro ao deletar.');
              }
            }
          });
        });
      }
    } catch (error) {
      console.error('Erro ao carregar exercícios:', error);
      const exercisesList = document.getElementById('exercisesList');
      if (exercisesList) {
        exercisesList.innerHTML = `
          <div style="text-align: center; padding: 40px; background: #fff3f3; border-radius: 12px; border: 2px solid #ffdddd;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#cc0000" stroke-width="2" style="margin: 0 auto 15px; display: block;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p style="color: #cc0000; font-size: 16px; margin: 0;">Erro ao carregar exercícios</p>
          </div>
        `;
      }
    }
  }

  await loadExercises();
})();
</script>