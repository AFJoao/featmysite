<div class="exercises-page">
  <header>
    <h1>Gerenciar Exerc√≠cios</h1>
    <nav>
      <a href="#/personal/dashboard">Dashboard</a>
      <a href="#/personal/create-workout">Criar Treino</a>
      <a href="#" id="logoutBtn">Sair</a>
    </nav>
  </header>

  <div style="max-width: 1000px; margin: 30px auto;">
    <h2>Meus Exerc√≠cios</h2>

    <div style="margin-bottom: 30px; border: 2px solid #000000; padding: 20px;">
      <h3>Criar Novo Exerc√≠cio</h3>
      
      <div id="createError" class="alert error" style="display: none;"></div>
      <div id="createSuccess" class="alert success" style="display: none;"></div>

      <div class="form-group">
        <label for="exerciseName">Nome do Exerc√≠cio:</label>
        <input type="text" id="exerciseName" placeholder="Ex: Supino Reto" required>
      </div>

      <div class="form-group">
        <label for="exerciseDescription">Descri√ß√£o:</label>
        <textarea id="exerciseDescription" placeholder="Descreva o exerc√≠cio, m√∫sculos trabalhados, etc."></textarea>
      </div>

      <div class="form-group">
        <label for="exerciseVideo">URL do V√≠deo (YouTube):</label>
        <input type="text" id="exerciseVideo" placeholder="Ex: https://www.youtube.com/watch?v=dQw4w9WgXcQ">
        <small style="display: block; margin-top: 5px; color: #666;">
          ‚úì Cole o link normal do YouTube (watch?v= ou youtu.be/)<br>
          ‚úì O sistema converter√° automaticamente para o formato correto
        </small>
        <div id="videoPreview" style="margin-top: 10px; display: none;">
          <div style="border: 2px solid #000; padding: 10px; background: #f5f5f5;">
            <strong>‚úì Pr√©via do v√≠deo:</strong>
            <div id="videoPreviewFrame" style="margin-top: 10px; position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden;">
            </div>
          </div>
        </div>
      </div>

      <button id="createExerciseBtn" type="button">Criar Exerc√≠cio</button>
    </div>

    <h3>Lista de Exerc√≠cios (<span id="exercisesCount">0</span>)</h3>
    <div id="exercisesList" class="exercises-list">
      <div class="loading"><div class="spinner"></div><p>Carregando...</p></div>
    </div>
  </div>
</div>

<script>
(async function() {
  console.log('=== P√ÅGINA DE EXERC√çCIOS - INICIANDO ===');

  // Aguardar DOM
  await new Promise(resolve => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });

  await new Promise(resolve => setTimeout(resolve, 100));

  console.log('‚úì DOM pronto');

  // Logout
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await authManager.logout();
      router.goToLogin();
    });
  }

  // Pr√©via do v√≠deo
  const videoInput = document.getElementById('exerciseVideo');
  const videoPreview = document.getElementById('videoPreview');
  const videoPreviewFrame = document.getElementById('videoPreviewFrame');

  if (videoInput) {
    videoInput.addEventListener('input', (e) => {
      const url = e.target.value.trim();
      
      if (url === '') {
        videoPreview.style.display = 'none';
        return;
      }

      const embedUrl = dbManager.convertYouTubeUrl(url);
      
      if (embedUrl && embedUrl.includes('/embed/')) {
        videoPreview.style.display = 'block';
        videoPreviewFrame.innerHTML = `
          <iframe 
            src="${embedUrl}" 
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
            allowfullscreen>
          </iframe>
        `;
      } else {
        videoPreview.style.display = 'none';
      }
    });
  }

  // Criar exerc√≠cio
  const createExerciseBtn = document.getElementById('createExerciseBtn');
  if (createExerciseBtn) {
    createExerciseBtn.addEventListener('click', async () => {
      console.log('=== CRIAR EXERC√çCIO ===');
      
      const name = document.getElementById('exerciseName')?.value.trim();
      const description = document.getElementById('exerciseDescription')?.value.trim();
      const videoUrl = document.getElementById('exerciseVideo')?.value.trim();
      const errorDiv = document.getElementById('createError');
      const successDiv = document.getElementById('createSuccess');

      if (!errorDiv || !successDiv) return;

      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      if (!name) {
        errorDiv.textContent = '‚ùå Nome do exerc√≠cio √© obrigat√≥rio';
        errorDiv.style.display = 'block';
        return;
      }

      createExerciseBtn.textContent = '‚è≥ Criando...';
      createExerciseBtn.disabled = true;

      try {
        const result = await dbManager.createExercise(name, description || '', videoUrl || '');
        console.log('Resultado:', result);

        if (result.success) {
          successDiv.innerHTML = '‚úì <strong>Exerc√≠cio criado!</strong><br><small>Atualizando lista...</small>';
          successDiv.style.display = 'block';
          
          document.getElementById('exerciseName').value = '';
          document.getElementById('exerciseDescription').value = '';
          document.getElementById('exerciseVideo').value = '';
          videoPreview.style.display = 'none';

          setTimeout(async () => {
            successDiv.style.display = 'none';
            await loadExercises();
            createExerciseBtn.textContent = 'Criar Exerc√≠cio';
            createExerciseBtn.disabled = false;
          }, 1500);
        } else {
          errorDiv.textContent = '‚ùå ' + result.error;
          errorDiv.style.display = 'block';
          createExerciseBtn.textContent = 'Criar Exerc√≠cio';
          createExerciseBtn.disabled = false;
        }
      } catch (error) {
        console.error('Erro:', error);
        errorDiv.textContent = '‚ùå Erro: ' + error.message;
        errorDiv.style.display = 'block';
        createExerciseBtn.textContent = 'Criar Exerc√≠cio';
        createExerciseBtn.disabled = false;
      }
    });
  }

  // Carregar exerc√≠cios
  async function loadExercises() {
    try {
      console.log('=== CARREGANDO EXERC√çCIOS ===');
      
      const exercisesList = document.getElementById('exercisesList');
      const exercisesCount = document.getElementById('exercisesCount');

      if (!exercisesList || !exercisesCount) return;

      const exercises = await dbManager.getPersonalExercises();
      console.log('Exerc√≠cios retornados:', exercises.length);

      exercisesCount.textContent = exercises.length;

      if (exercises.length === 0) {
        exercisesList.innerHTML = `
          <div class="card" style="background-color: #f5f5f5;">
            <p style="margin: 0; color: #666;">
              Nenhum exerc√≠cio criado ainda.<br>
              Crie seu primeiro exerc√≠cio usando o formul√°rio acima.
            </p>
          </div>
        `;
      } else {
        exercisesList.innerHTML = exercises.map(exercise => {
          const hasVideo = exercise.videoUrl && exercise.videoUrl.trim() !== '';
          
          return `
            <div class="exercise-item" style="flex-direction: column; align-items: flex-start;">
              <div style="width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <h4 style="margin: 0 0 5px 0;">${exercise.name}</h4>
                    <p style="margin: 0; font-size: 14px; color: #666;">${exercise.description || 'Sem descri√ß√£o'}</p>
                  </div>
                  <button 
                    data-exercise-id="${exercise.id}" 
                    class="delete-exercise-btn danger" 
                    style="padding: 8px 12px; font-size: 12px;">
                    üóëÔ∏è Deletar
                  </button>
                </div>
                
                ${hasVideo ? `
                  <div style="margin-top: 10px; position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border: 2px solid #000;">
                    <iframe 
                      src="${exercise.videoUrl}" 
                      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                      allowfullscreen>
                    </iframe>
                  </div>
                ` : `
                  <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">üìπ Sem v√≠deo</p>
                `}
              </div>
            </div>
          `;
        }).join('');

        // Event listeners para deletar
        document.querySelectorAll('.delete-exercise-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const exerciseId = btn.getAttribute('data-exercise-id');
            
            if (confirm('‚ö†Ô∏è Tem certeza que deseja deletar este exerc√≠cio?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
              try {
                const result = await dbManager.deleteExercise(exerciseId);
                if (result.success) {
                  alert('‚úì Exerc√≠cio deletado!');
                  loadExercises();
                } else {
                  alert('‚ùå Erro: ' + result.error);
                }
              } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao deletar.');
              }
            }
          });
        });
      }

      console.log('‚úì Exerc√≠cios carregados');
    } catch (error) {
      console.error('‚ùå Erro ao carregar exerc√≠cios:', error);
      const exercisesList = document.getElementById('exercisesList');
      if (exercisesList) {
        exercisesList.innerHTML = `
          <div class="card" style="border-color: #cc0000;">
            <p style="color: #cc0000;">
              <strong>‚ùå Erro ao carregar exerc√≠cios.</strong><br>
              ${error.message}
            </p>
          </div>
        `;
      }
    }
  }

  // Carregar lista
  await loadExercises();

  console.log('=== P√ÅGINA DE EXERC√çCIOS CARREGADA ===');
})();
</script>