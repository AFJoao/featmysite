<div class="student-view-workout">
  <link rel="stylesheet" href="css/mobile-responsive-fixes.css">
  <header style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;">
    <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <button id="backBtn" style="background: rgba(255,255,255,0.1); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.borderColor='#ffffff';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.3)';">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <h1 style="color: #ffffff; font-size: 24px; font-weight: 600; margin: 0;">Treino</h1>
      </div>
      <button id="logoutBtn" style="background: transparent; color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Sair
      </button>
    </div>
  </header>

  <div id="pageLoading" style="text-align: center; padding: 80px 20px;">
    <div class="spinner" style="margin: 0 auto 20px;"></div>
    <p style="color: #999; font-size: 16px;">Carregando treino...</p>
  </div>

  <div id="mainContent" style="display: none; max-width: 1200px; margin: 0 auto; padding: 30px 20px;"></div>
</div>

<script>
(async function() {
  const daysMap = {
    monday: 'Segunda-feira',
    tuesday: 'Terça-feira',
    wednesday: 'Quarta-feira',
    thursday: 'Quinta-feira',
    friday: 'Sexta-feira',
    saturday: 'Sábado',
    sunday: 'Domingo'
  };

  const daysOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

  await new Promise(resolve => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });

  await new Promise(resolve => setTimeout(resolve, 100));

  const backBtn = document.getElementById('backBtn');
  if (backBtn) {
    backBtn.addEventListener('click', (e) => {
      e.preventDefault();
      router.goToStudentDashboard();
    });
  }

  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('mouseover', () => {
      logoutBtn.style.background = 'rgba(255,255,255,0.1)';
      logoutBtn.style.borderColor = '#ffffff';
    });
    logoutBtn.addEventListener('mouseout', () => {
      logoutBtn.style.background = 'transparent';
      logoutBtn.style.borderColor = 'rgba(255,255,255,0.3)';
    });
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await authManager.logout();
      router.goToLogin();
    });
  }

  let currentDay = null;
  let completedExercises = {};
  let workoutId = null;

  async function loadCompletedStatus(wId) {
    try {
      const user = authManager.getCurrentUser();
      if (!user || !wId) return;

      const completionDoc = await db.collection('workoutCompletions')
        .doc(`${user.uid}_${wId}`)
        .get();

      if (completionDoc.exists) {
        completedExercises = completionDoc.data().completed || {};
        console.log('✓ Status carregado do Firestore:', completedExercises);
      } else {
        completedExercises = {};
      }
    } catch (error) {
      console.error('Erro ao carregar status:', error);
      completedExercises = {};
    }
  }

  async function saveCompletedStatus(wId) {
    try {
      const user = authManager.getCurrentUser();
      if (!user || !wId) return;

      await db.collection('workoutCompletions')
        .doc(`${user.uid}_${wId}`)
        .set({
          userId: user.uid,
          workoutId: wId,
          completed: completedExercises,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

      console.log('✓ Status salvo no Firestore');
    } catch (error) {
      console.error('Erro ao salvar status:', error);
    }
  }

  async function toggleExerciseCompletion(wId, day, exerciseIndex) {
    const key = `${day}_${exerciseIndex}`;
    completedExercises[key] = !completedExercises[key];
    
    const checkbox = document.getElementById(`check_${wId}_${key}`);
    const card = document.getElementById(`card_${wId}_${key}`);
    
    if (checkbox && card) {
      if (completedExercises[key]) {
        checkbox.innerHTML = `
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        `;
        card.style.opacity = '0.7';
        card.style.background = 'linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%)';
        card.style.borderColor = '#86efac';
      } else {
        checkbox.innerHTML = `
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          </svg>
        `;
        card.style.opacity = '1';
        card.style.background = '#ffffff';
        card.style.borderColor = '#e0e0e0';
      }
    }

    await saveCompletedStatus(wId);
  }

  window.toggleExerciseFunc = toggleExerciseCompletion;

  window.switchDayFunc = function(day) {
    currentDay = day;
    document.querySelectorAll('.day-btn').forEach(btn => {
      if (btn.dataset.day === day) {
        btn.style.background = '#000000';
        btn.style.color = '#ffffff';
        btn.style.borderColor = '#000000';
      } else {
        btn.style.background = '#ffffff';
        btn.style.color = '#000000';
        btn.style.borderColor = '#e0e0e0';
      }
    });
    
    document.querySelectorAll('.day-content').forEach(content => {
      content.style.display = content.dataset.day === day ? 'block' : 'none';
    });
  };

  async function loadWorkout() {
    const wId = sessionStorage.getItem('viewWorkoutId');
    workoutId = wId;
    const container = document.getElementById('mainContent');
    const loading = document.getElementById('pageLoading');
    
    if (!wId) {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; background: #fff3f3; border-radius: 12px; border: 2px solid #ffdddd;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#cc0000" stroke-width="2" style="margin: 0 auto 20px; display: block;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <p style="color: #cc0000; font-size: 18px; margin: 0;">Treino não encontrado</p>
        </div>
      `;
      loading.style.display = 'none';
      container.style.display = 'block';
      return;
    }

    try {
      const workout = await dbManager.getWorkoutById(wId);
      
      if (!workout) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; background: #fff3f3; border-radius: 12px; border: 2px solid #ffdddd;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#cc0000" stroke-width="2" style="margin: 0 auto 20px; display: block;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <p style="color: #cc0000; font-size: 18px; margin: 0;">Treino não encontrado</p>
          </div>
        `;
        loading.style.display = 'none';
        container.style.display = 'block';
        return;
      }

      let html = `
        <div style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 30px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
          <h2 style="font-size: 32px; font-weight: 700; margin: 0 0 12px 0; color: #000000;">${workout.name}</h2>
          ${workout.description ? `<p style="color: #666; font-size: 16px; margin: 0; line-height: 1.6;">${workout.description}</p>` : ''}
        </div>
      `;

      const daysWithExercises = daysOrder.filter(day => 
        workout.days && workout.days[day] && workout.days[day].length > 0
      );

      if (daysWithExercises.length === 0) {
        html += `
          <div style="text-align: center; padding: 60px 20px; background: #f8f8f8; border-radius: 12px; border: 2px dashed #ddd;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="margin: 0 auto 20px; display: block;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p style="color: #666; font-size: 18px; margin: 0;">Este treino não possui exercícios</p>
          </div>
        `;
      } else {
        html += `
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; background: #ffffff; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            ${daysWithExercises.map((day, index) => {
              const isFirst = index === 0;
              return `
                <button 
                  class="day-btn" 
                  data-day="${day}" 
                  onclick="switchDayFunc('${day}')"
                  style="flex: 1; min-width: 120px; padding: 14px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 15px; font-weight: 600; border: 2px solid ${isFirst ? '#000000' : '#e0e0e0'}; background: ${isFirst ? '#000000' : '#ffffff'}; color: ${isFirst ? '#ffffff' : '#000000'};">
                  ${daysMap[day]}
                </button>
              `;
            }).join('')}
          </div>
        `;

        for (let i = 0; i < daysWithExercises.length; i++) {
          const day = daysWithExercises[i];
          const exercises = workout.days[day];
          const isFirst = i === 0;
          
          html += `
            <div class="day-content" data-day="${day}" style="display: ${isFirst ? 'block' : 'none'};">
              <h3 style="font-size: 24px; font-weight: 600; margin: 0 0 20px 0; color: #000000; display: flex; align-items: center; gap: 10px;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                ${daysMap[day]}
              </h3>
              <div style="display: flex; flex-direction: column; gap: 20px;">
          `;

          for (const exercise of exercises) {
            const hasVideo = exercise.videoUrl && exercise.videoUrl.trim() !== '';
            const exerciseIndex = exercises.indexOf(exercise);
            const key = `${day}_${exerciseIndex}`;
            const isCompleted = completedExercises[key] || false;
            
            html += `
              <div id="card_${wId}_${key}" style="background: ${isCompleted ? 'linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%)' : '#ffffff'}; border: 1px solid ${isCompleted ? '#86efac' : '#e0e0e0'}; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s; opacity: ${isCompleted ? '0.7' : '1'};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                  <h4 style="font-size: 20px; font-weight: 600; margin: 0; color: #000000; flex: 1;">${exercise.exerciseName}</h4>
                  <button 
                    id="check_${wId}_${key}"
                    onclick="toggleExerciseFunc('${wId}', '${day}', ${exerciseIndex})"
                    style="background: transparent; border: none; cursor: pointer; padding: 5px; transition: all 0.3s; display: flex; align-items: center; justify-content: center;"
                    onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">
                    ${isCompleted ? `
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    ` : `
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      </svg>
                    `}
                  </button>
                </div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: ${hasVideo ? '20px' : '0'};">
                  <div style="display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: #f8f8f8; border-radius: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                    <div>
                      <div style="font-size: 12px; color: #666; font-weight: 500;">SÉRIES</div>
                      <div style="font-size: 18px; font-weight: 700; color: #000000;">${exercise.sets}</div>
                    </div>
                  </div>
                  
                  <div style="display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: #f8f8f8; border-radius: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
                      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                      <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    <div>
                      <div style="font-size: 12px; color: #666; font-weight: 500;">REPETIÇÕES</div>
                      <div style="font-size: 18px; font-weight: 700; color: #000000;">${exercise.reps}</div>
                    </div>
                  </div>
                </div>

                ${exercise.notes && exercise.notes.trim() !== '' ? `
                  <div style="background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%); border-left: 4px solid #000000; padding: 15px 18px; border-radius: 8px; margin-top: 15px;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                      </svg>
                      <div>
                        <div style="font-size: 12px; font-weight: 600; color: #000000; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Observações</div>
                        <div style="font-size: 14px; color: #333; line-height: 1.6;">${exercise.notes}</div>
                      </div>
                    </div>
                  </div>
                ` : ''}

                ${hasVideo ? `
                  <div style="margin-top: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0;">
                      <iframe 
                        src="${exercise.videoUrl}" 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                      </iframe>
                    </div>
                  </div>
                ` : `
                  <div style="margin-top: 15px; padding: 20px; background: #f8f8f8; border-radius: 8px; text-align: center; border: 2px dashed #ddd;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="margin: 0 auto 10px; display: block;">
                      <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    <p style="color: #999; font-size: 14px; margin: 0;">Sem vídeo disponível</p>
                  </div>
                `}
              </div>
            `;
          }

          html += `
              </div>
            </div>
          `;
        }

        if (daysWithExercises.length > 0) {
          currentDay = daysWithExercises[0];
        }
      }

      container.innerHTML = html;
      loading.style.display = 'none';
      container.style.display = 'block';

    } catch (error) {
      console.error('Erro ao carregar treino:', error);
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; background: #fff3f3; border-radius: 12px; border: 2px solid #ffdddd;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#cc0000" stroke-width="2" style="margin: 0 auto 20px; display: block;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <p style="color: #cc0000; font-size: 18px; margin: 0 0 8px 0;">Erro ao carregar treino</p>
          <p style="color: #999; font-size: 14px; margin: 0;">${error.message}</p>
        </div>
      `;
      loading.style.display = 'none';
      container.style.display = 'block';
    }
  }

  await loadWorkout();
})();
</script>