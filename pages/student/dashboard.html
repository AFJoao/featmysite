<div class="student-dashboard">
  <link rel="stylesheet" href="css/mobile-responsive-fixes.css">
  <header style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <h1 style="color: #ffffff; font-size: 24px; font-weight: 600; margin: 0;">Meus Treinos</h1>
      </div>
      <button id="logoutBtn" style="background: transparent; color: #ffffff; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Sair
      </button>
    </div>
  </header>

  <div style="max-width: 1400px; margin: 0 auto; padding: 30px 20px;">
    <div style="margin-bottom: 30px;">
      <h2 style="font-size: 28px; font-weight: 600; margin: 0 0 8px 0;">Ol√°, <span id="studentName">...</span>! üëã</h2>
      <p style="color: #666; font-size: 16px; margin: 0;">Confira seus treinos da semana</p>
    </div>

    <div id="weeklyWorkouts" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
      <div style="text-align: center; padding: 30px; background: #f8f8f8; border-radius: 8px;">
        <div class="spinner" style="margin: 0 auto 15px;"></div>
        <p style="color: #999; font-size: 14px; margin: 0;">Carregando semana...</p>
      </div>
    </div>
  </div>

  <!-- Modal de Feedback -->
  <div id="feedbackModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: #ffffff; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="font-size: 24px; font-weight: 600; margin: 0; color: #000000;">Enviar Feedback</h3>
        <button id="closeFeedbackModal" style="background: transparent; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <form id="feedbackForm">
        <input type="hidden" id="feedbackWorkoutId">
        <input type="hidden" id="feedbackDayOfWeek">

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 14px; font-weight: 600; color: #000000; margin-bottom: 8px;">N√≠vel de Esfor√ßo (1-10)</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="range" id="effortLevel" min="1" max="10" value="5" style="flex: 1; height: 8px; border-radius: 4px; background: #e5e7eb; outline: none;">
            <span id="effortLevelValue" style="font-size: 18px; font-weight: 700; color: #000000; min-width: 30px; text-align: center;">5</span>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 14px; font-weight: 600; color: #000000; margin-bottom: 8px;">Sensa√ß√£o Geral</label>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <label style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;" id="sensationLeve">
              <input type="radio" name="sensation" value="leve" style="display: none;">
              <span style="font-size: 14px; font-weight: 500; color: #666;">Leve</span>
            </label>
            <label style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;" id="sensationIdeal">
              <input type="radio" name="sensation" value="ideal" checked style="display: none;">
              <span style="font-size: 14px; font-weight: 500; color: #666;">Ideal</span>
            </label>
            <label style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;" id="sensationPesado">
              <input type="radio" name="sensation" value="pesado" style="display: none;">
              <span style="font-size: 14px; font-weight: 500; color: #666;">Pesado</span>
            </label>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 14px; font-weight: 600; color: #000000; margin-bottom: 8px;">Dor ou Desconforto?</label>
          <div style="display: flex; gap: 10px;">
            <label style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;" id="hasPainSim">
              <input type="radio" name="hasPain" value="true" style="display: none;">
              <span style="font-size: 14px; font-weight: 500; color: #666;">Sim</span>
            </label>
            <label style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;" id="hasPainNao">
              <input type="radio" name="hasPain" value="false" checked style="display: none;">
              <span style="font-size: 14px; font-weight: 500; color: #666;">N√£o</span>
            </label>
          </div>
        </div>

        <div id="painLocationContainer" style="margin-bottom: 20px; display: none;">
          <label style="display: block; font-size: 14px; font-weight: 600; color: #000000; margin-bottom: 8px;">Local da Dor</label>
          <input type="text" id="painLocation" placeholder="Ex: Ombro direito, joelho esquerdo..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box;">
        </div>

        <div style="margin-bottom: 25px;">
          <label style="display: block; font-size: 14px; font-weight: 600; color: #000000; margin-bottom: 8px;">Coment√°rio (opcional)</label>
          <textarea id="feedbackComment" rows="3" placeholder="Compartilhe como foi o treino..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; resize: vertical; box-sizing: border-box; font-family: inherit;"></textarea>
        </div>

        <div style="display: flex; gap: 10px;">
          <button type="button" id="cancelFeedbackBtn" style="flex: 1; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; background: #ffffff; color: #666; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Cancelar</button>
          <button type="submit" style="flex: 1; padding: 14px; border: none; border-radius: 8px; background: #000000; color: #ffffff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Enviar Feedback</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Modelo de Feedback (inline para evitar problemas de carregamento)
if (typeof window.feedbackModel === 'undefined') {
  window.feedbackModel = {
    getCurrentWeekIdentifier: function() {
      const now = new Date();
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      const pastDaysOfYear = (now - startOfYear) / 86400000;
      const weekNumber = Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
      return `${now.getFullYear()}-${weekNumber}`;
    },
    getFeedbackKey: function(studentId, workoutId, weekIdentifier, dayOfWeek) {
      return `${studentId}_${workoutId}_${weekIdentifier}_${dayOfWeek}`;
    },
    validateFeedbackData: function(data) {
      const errors = [];
      if (!data.studentId || typeof data.studentId !== 'string') errors.push('studentId √© obrigat√≥rio');
      if (!data.workoutId || typeof data.workoutId !== 'string') errors.push('workoutId √© obrigat√≥rio');
      if (!data.weekIdentifier || typeof data.weekIdentifier !== 'string') errors.push('weekIdentifier √© obrigat√≥rio');
      if (!data.dayOfWeek || !['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].includes(data.dayOfWeek)) {
        errors.push('dayOfWeek inv√°lido');
      }
      if (typeof data.effortLevel !== 'number' || data.effortLevel < 1 || data.effortLevel > 10) {
        errors.push('effortLevel deve ser um n√∫mero entre 1 e 10');
      }
      if (!['leve', 'ideal', 'pesado'].includes(data.sensation)) {
        errors.push('sensation deve ser "leve", "ideal" ou "pesado"');
      }
      if (typeof data.hasPain !== 'boolean') errors.push('hasPain deve ser boolean');
      if (data.hasPain && (!data.painLocation || data.painLocation.trim() === '')) {
        errors.push('painLocation √© obrigat√≥rio quando hasPain √© true');
      }
      return { isValid: errors.length === 0, errors };
    }
  };
}

(async function() {
  const daysMap = {
    monday: { name: 'Segunda', short: 'SEG' },
    tuesday: { name: 'Ter√ßa', short: 'TER' },
    wednesday: { name: 'Quarta', short: 'QUA' },
    thursday: { name: 'Quinta', short: 'QUI' },
    friday: { name: 'Sexta', short: 'SEX' },
    saturday: { name: 'S√°bado', short: 'S√ÅB' },
    sunday: { name: 'Domingo', short: 'DOM' }
  };

  const daysOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

  await new Promise(resolve => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });

  await new Promise(resolve => setTimeout(resolve, 100));

  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('mouseover', () => {
      logoutBtn.style.background = 'rgba(255,255,255,0.1)';
      logoutBtn.style.borderColor = '#ffffff';
    });
    logoutBtn.addEventListener('mouseout', () => {
      logoutBtn.style.background = 'transparent';
      logoutBtn.style.borderColor = 'rgba(255,255,255,0.3)';
    });
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await authManager.logout();
      router.goToLogin();
    });
  }

  window.viewWorkoutFunc = function(workoutId) {
    sessionStorage.setItem('viewWorkoutId', workoutId);
    router.goToViewWorkout();
  };

  async function getWorkoutCompletion(workoutId) {
    try {
      const user = authManager.getCurrentUser();
      if (!user) return { completed: 0, total: 0, percentage: 0 };

      const completionDoc = await db.collection('workoutCompletions')
        .doc(`${user.uid}_${workoutId}`)
        .get();

      if (!completionDoc.exists) {
        return { completed: 0, total: 0, percentage: 0 };
      }

      const completedExercises = completionDoc.data().completed || {};
      const completedCount = Object.values(completedExercises).filter(v => v === true).length;
      
      return {
        completed: completedCount,
        completedExercises: completedExercises
      };
    } catch (error) {
      console.error('Erro ao obter conclus√£o:', error);
      return { completed: 0, total: 0, percentage: 0 };
    }
  }

  async function calculateWorkoutProgress(workout) {
    if (!workout.days) return { completed: 0, total: 0, percentage: 0 };

    let totalExercises = 0;
    Object.values(workout.days).forEach(dayExercises => {
      if (Array.isArray(dayExercises)) {
        totalExercises += dayExercises.length;
      }
    });

    const completion = await getWorkoutCompletion(workout.id);
    const percentage = totalExercises > 0 ? Math.round((completion.completed / totalExercises) * 100) : 0;

    return {
      completed: completion.completed,
      total: totalExercises,
      percentage: percentage
    };
  }

  async function loadStudentData() {
    try {
      const studentNameSpan = document.getElementById('studentName');
      if (!studentNameSpan) return;

      const userData = await dbManager.getCurrentUserData();
      if (userData) {
        studentNameSpan.textContent = userData.name || 'Aluno';
      }
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
    }
  }

  async function loadWorkouts() {
    try {
      const workouts = await dbManager.getStudentWorkouts();
      const weeklyContainer = document.getElementById('weeklyWorkouts');
      
      if (!workouts || workouts.length === 0) {
        weeklyContainer.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: #f8f8f8; border-radius: 12px; border: 2px dashed #ddd;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="margin: 0 auto 15px; display: block;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p style="color: #666; font-size: 16px; margin: 0;">Nenhum treino atribu√≠do ainda</p>
            <p style="color: #999; font-size: 14px; margin: 5px 0 0 0;">Aguarde seu personal trainer atribuir treinos</p>
          </div>
        `;
        return;
      }

      const weeklyWorkouts = {};
      daysOrder.forEach(day => { weeklyWorkouts[day] = []; });

      workouts.forEach(workout => {
        if (workout.days) {
          Object.keys(workout.days).forEach(day => {
            if (workout.days[day] && workout.days[day].length > 0) {
              weeklyWorkouts[day].push(workout);
            }
          });
        }
      });

      let weeklyHTML = '';
      daysOrder.forEach(day => {
        const dayWorkouts = weeklyWorkouts[day];
        const today = new Date().getDay();
        const dayIndex = daysOrder.indexOf(day);
        const adjustedDayIndex = dayIndex === 6 ? 0 : dayIndex + 1;
        const isToday = today === adjustedDayIndex;

        weeklyHTML += `
          <div style="background: ${isToday ? 'linear-gradient(135deg, #000000 0%, #2d2d2d 100%)' : '#ffffff'}; border: ${isToday ? 'none' : '1px solid #e0e0e0'}; border-radius: 10px; padding: 20px; min-height: 180px; box-shadow: ${isToday ? '0 4px 12px rgba(0,0,0,0.15)' : '0 2px 8px rgba(0,0,0,0.05)'}; transition: all 0.3s;">
            <div style="text-align: center; margin-bottom: 15px;">
              <div style="font-size: 12px; font-weight: 600; color: ${isToday ? '#ffffff' : '#999'}; letter-spacing: 1px; margin-bottom: 5px;">${daysMap[day].short}</div>
              <div style="font-size: 18px; font-weight: 600; color: ${isToday ? '#ffffff' : '#000000'};">${daysMap[day].name}</div>
              ${isToday ? '<div style="width: 30px; height: 3px; background: #ffffff; margin: 8px auto 0; border-radius: 2px;"></div>' : ''}
            </div>
            <div id="day-${day}-workouts" style="display: flex; flex-direction: column; gap: 10px;">
              <div style="text-align: center; padding: 20px 10px;">
                <div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0 auto;"></div>
              </div>
            </div>
          </div>
        `;
      });

      weeklyContainer.innerHTML = weeklyHTML;

      // Carregar progresso de cada treino
      for (const day of daysOrder) {
        const dayWorkouts = weeklyWorkouts[day];
        const dayContainer = document.getElementById(`day-${day}-workouts`);
        const today = new Date().getDay();
        const dayIndex = daysOrder.indexOf(day);
        const adjustedDayIndex = dayIndex === 6 ? 0 : dayIndex + 1;
        const isToday = today === adjustedDayIndex;

        if (dayWorkouts.length === 0) {
          dayContainer.innerHTML = `
            <div style="text-align: center; padding: 20px 10px; color: ${isToday ? 'rgba(255,255,255,0.6)' : '#999'}; font-size: 13px;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 8px; display: block; opacity: 0.5;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              Sem treino
            </div>
          `;
        } else {
          console.log(`Renderizando ${dayWorkouts.length} treino(s) para ${day}`);
          let dayHTML = '';
          for (const w of dayWorkouts) {
            const progress = await calculateWorkoutProgress(w);
            const exerciseCount = (w.days[day] || []).length;
            const isCompleted = progress.percentage === 100;
            
            // Verificar se j√° existe feedback para este dia
            let weekIdentifier = '';
            let hasFeedback = false;
            
            try {
              if (window.feedbackModel && typeof window.feedbackModel.getCurrentWeekIdentifier === 'function') {
                weekIdentifier = window.feedbackModel.getCurrentWeekIdentifier();
              } else {
                // Fallback: calcular semana manualmente
                const now = new Date();
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                const pastDaysOfYear = (now - startOfYear) / 86400000;
                const weekNumber = Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
                weekIdentifier = `${now.getFullYear()}-${weekNumber}`;
              }
              
              if (dbManager && typeof dbManager.hasFeedbackForDay === 'function') {
                hasFeedback = await dbManager.hasFeedbackForDay(w.id, day, weekIdentifier);
              }
            } catch (error) {
              console.error('Erro ao verificar feedback:', error);
              hasFeedback = false;
            }
            
            console.log(`Feedback check - Workout: ${w.id}, Day: ${day}, Week: ${weekIdentifier}, HasFeedback: ${hasFeedback}`);
            
            dayHTML += `
              <div style="background: ${isToday ? 'rgba(255,255,255,0.1)' : (isCompleted ? 'linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%)' : '#f8f8f8')}; border: 1px solid ${isToday ? 'rgba(255,255,255,0.2)' : (isCompleted ? '#86efac' : '#e8e8e8')}; border-radius: 8px; padding: 12px; transition: all 0.2s; position: relative; overflow: hidden;">
                ${isCompleted ? `
                  <div style="position: absolute; top: 8px; right: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </div>
                ` : ''}
                <div onclick="viewWorkoutFunc('${w.id}')" style="cursor: pointer;">
                  <div style="font-weight: 600; font-size: 13px; color: ${isToday ? '#ffffff' : '#000000'}; margin-bottom: 6px; line-height: 1.3; padding-right: ${isCompleted ? '25px' : '0'};">${w.name}</div>
                  <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: ${isToday ? 'rgba(255,255,255,0.7)' : '#666'}; margin-bottom: 8px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    ${exerciseCount} exerc√≠cio${exerciseCount !== 1 ? 's' : ''}
                  </div>
                  ${progress.total > 0 ? `
                    <div style="margin-top: 8px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-size: 10px; color: ${isToday ? 'rgba(255,255,255,0.7)' : '#666'}; font-weight: 600;">PROGRESSO</span>
                        <span style="font-size: 10px; color: ${isToday ? 'rgba(255,255,255,0.9)' : '#000000'}; font-weight: 700;">${progress.percentage}%</span>
                      </div>
                      <div style="width: 100%; height: 6px; background: ${isToday ? 'rgba(255,255,255,0.2)' : '#e5e7eb'}; border-radius: 3px; overflow: hidden;">
                        <div style="width: ${progress.percentage}%; height: 100%; background: ${isCompleted ? '#22c55e' : (isToday ? '#ffffff' : '#000000')}; transition: width 0.3s; border-radius: 3px;"></div>
                      </div>
                    </div>
                  ` : ''}
                </div>
                ${hasFeedback ? `
                  <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid ${isToday ? 'rgba(255,255,255,0.2)' : '#e0e0e0'};">
                    <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: ${isToday ? 'rgba(255,255,255,0.8)' : '#22c55e'}; font-weight: 600;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      Feedback enviado
                    </div>
                  </div>
                ` : `
                  <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid ${isToday ? 'rgba(255,255,255,0.2)' : '#e0e0e0'};">
                    <button onclick="event.stopPropagation(); openFeedbackModal('${w.id}', '${day}')" style="width: 100%; padding: 8px; background: ${isToday ? 'rgba(255,255,255,0.2)' : '#000000'}; color: ${isToday ? '#ffffff' : '#ffffff'}; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                      </svg>
                      Enviar feedback
                    </button>
                  </div>
                `}
              </div>
            `;
          }
          dayContainer.innerHTML = dayHTML;
        }
      }

    } catch (error) {
      console.error('Erro ao carregar treinos:', error);
      document.getElementById('weeklyWorkouts').innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: #fff3f3; border-radius: 12px; border: 2px solid #ffdddd;">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#cc0000" stroke-width="2" style="margin: 0 auto 15px; display: block;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <p style="color: #cc0000; font-size: 16px; margin: 0;">Erro ao carregar treinos</p>
        </div>
      `;
    }
  }

  // Fun√ß√£o para abrir modal de feedback
  window.openFeedbackModal = function(workoutId, dayOfWeek) {
    console.log('Abrindo modal de feedback:', workoutId, dayOfWeek);
    const modal = document.getElementById('feedbackModal');
    const workoutIdInput = document.getElementById('feedbackWorkoutId');
    const dayInput = document.getElementById('feedbackDayOfWeek');
    
    if (!modal) {
      console.error('Modal n√£o encontrado!');
      alert('Erro: Modal de feedback n√£o encontrado. Recarregue a p√°gina.');
      return;
    }
    
    if (!workoutIdInput || !dayInput) {
      console.error('Inputs do modal n√£o encontrados!');
      return;
    }
    
    workoutIdInput.value = workoutId;
    dayInput.value = dayOfWeek;
    
    modal.style.display = 'flex';
    console.log('Modal aberto com sucesso');
  };

  // Fechar modal
  const closeFeedbackModal = document.getElementById('closeFeedbackModal');
  const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
  const feedbackModal = document.getElementById('feedbackModal');

  if (closeFeedbackModal) {
    closeFeedbackModal.addEventListener('click', () => {
      feedbackModal.style.display = 'none';
    });
  }

  if (cancelFeedbackBtn) {
    cancelFeedbackBtn.addEventListener('click', () => {
      feedbackModal.style.display = 'none';
    });
  }

  // Fechar ao clicar fora
  if (feedbackModal) {
    feedbackModal.addEventListener('click', (e) => {
      if (e.target === feedbackModal) {
        feedbackModal.style.display = 'none';
      }
    });
  }

  // Atualizar valor do esfor√ßo
  const effortLevel = document.getElementById('effortLevel');
  const effortLevelValue = document.getElementById('effortLevelValue');
  if (effortLevel && effortLevelValue) {
    effortLevel.addEventListener('input', (e) => {
      effortLevelValue.textContent = e.target.value;
    });
  }

  // Mostrar/ocultar campo de local da dor
  const hasPainInputs = document.querySelectorAll('input[name="hasPain"]');
  const painLocationContainer = document.getElementById('painLocationContainer');
  const painLocationInput = document.getElementById('painLocation');

  hasPainInputs.forEach(input => {
    input.addEventListener('change', (e) => {
      if (painLocationContainer) {
        painLocationContainer.style.display = e.target.value === 'true' ? 'block' : 'none';
        if (e.target.value === 'false' && painLocationInput) {
          painLocationInput.value = '';
        }
      }
    });
  });

  // Estilizar sele√ß√£o de sensa√ß√£o
  const sensationLabels = ['sensationLeve', 'sensationIdeal', 'sensationPesado'];
  sensationLabels.forEach(labelId => {
    const label = document.getElementById(labelId);
    if (label) {
      const radio = label.querySelector('input[type="radio"]');
      if (radio) {
        radio.addEventListener('change', () => {
          sensationLabels.forEach(id => {
            const lbl = document.getElementById(id);
            if (lbl) {
              lbl.style.borderColor = '#e0e0e0';
              lbl.style.background = '#ffffff';
            }
          });
          label.style.borderColor = '#000000';
          label.style.background = '#f8f8f8';
        });
        if (radio.checked) {
          label.style.borderColor = '#000000';
          label.style.background = '#f8f8f8';
        }
      }
    }
  });

  // Estilizar sele√ß√£o de dor
  const painLabels = ['hasPainSim', 'hasPainNao'];
  painLabels.forEach(labelId => {
    const label = document.getElementById(labelId);
    if (label) {
      const radio = label.querySelector('input[type="radio"]');
      if (radio) {
        radio.addEventListener('change', () => {
          painLabels.forEach(id => {
            const lbl = document.getElementById(id);
            if (lbl) {
              lbl.style.borderColor = '#e0e0e0';
              lbl.style.background = '#ffffff';
            }
          });
          label.style.borderColor = '#000000';
          label.style.background = '#f8f8f8';
        });
        if (radio.checked) {
          label.style.borderColor = '#000000';
          label.style.background = '#f8f8f8';
        }
      }
    }
  });

  // Enviar feedback
  const feedbackForm = document.getElementById('feedbackForm');
  if (feedbackForm) {
    feedbackForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const workoutId = document.getElementById('feedbackWorkoutId').value;
      const dayOfWeek = document.getElementById('feedbackDayOfWeek').value;
      const effortLevel = parseInt(document.getElementById('effortLevel').value);
      const sensation = document.querySelector('input[name="sensation"]:checked')?.value;
      const hasPain = document.querySelector('input[name="hasPain"]:checked')?.value === 'true';
      const painLocation = document.getElementById('painLocation').value;
      const comment = document.getElementById('feedbackComment').value;

      const weekIdentifier = window.feedbackModel?.getCurrentWeekIdentifier();

      const result = await dbManager.createFeedback({
        workoutId,
        dayOfWeek,
        effortLevel,
        sensation,
        hasPain,
        painLocation: hasPain ? painLocation : '',
        comment: comment || '',
        weekIdentifier
      });

      if (result.success) {
        alert('Feedback enviado com sucesso!');
        feedbackModal.style.display = 'none';
        feedbackForm.reset();
        document.getElementById('effortLevelValue').textContent = '5';
        document.getElementById('effortLevel').value = '5';
        painLocationContainer.style.display = 'none';
        await loadWorkouts();
      } else {
        alert('Erro ao enviar feedback: ' + result.error);
      }
    });
  }

  console.log('‚úì Dashboard Aluno carregado - feedbackModel dispon√≠vel:', typeof window.feedbackModel !== 'undefined');
  console.log('‚úì Modal de feedback presente:', document.getElementById('feedbackModal') !== null);

  await loadStudentData();
  await loadWorkouts();
  
  console.log('‚úì Treinos carregados - verifique os cards para ver o bot√£o "Enviar feedback"');
})();
</script>

<style>
.spinner {
  width: 32px;
  height: 32px;
  border: 4px solid #ddd;
  border-top-color: #000;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>