<div class="signup-container">
  <form id="signupForm">
    <h2>Cadastro</h2>
    
    <div id="signupError" class="alert error" style="display: none;"></div>
    <div id="signupSuccess" class="alert success" style="display: none;"></div>
    
    <div class="form-group">
      <label for="signupName">Nome:</label>
      <input type="text" id="signupName" required>
    </div>

    <div class="form-group">
      <label for="signupEmail">Email:</label>
      <input type="email" id="signupEmail" required>
    </div>

    <div class="form-group">
      <label for="signupPassword">Senha:</label>
      <input type="password" id="signupPassword" required minlength="6">
    </div>

    <div class="form-group">
      <label for="signupPasswordConfirm">Confirmar Senha:</label>
      <input type="password" id="signupPasswordConfirm" required minlength="6">
    </div>

    <div class="form-group">
      <label>Tipo de Usu√°rio:</label>
      <div class="radio-group">
        <div class="radio-item">
          <input type="radio" id="typePersonal" name="userType" value="personal" required>
          <label for="typePersonal">Personal Trainer</label>
        </div>
        <div class="radio-item">
          <input type="radio" id="typeStudent" name="userType" value="student" required>
          <label for="typeStudent">Aluno</label>
        </div>
      </div>
    </div>

    <div class="form-group" id="referralCodeGroup" style="display: none;">
      <label for="referralCode">C√≥digo do Personal Trainer:</label>
      <input type="text" id="referralCode" placeholder="Ex: ABC123" maxlength="6" style="text-transform: uppercase;">
      <small style="display: block; margin-top: 5px; color: #666;">
        Solicite o c√≥digo ao seu Personal Trainer
      </small>
      <div id="codeValidation" style="margin-top: 5px; display: none;"></div>
    </div>

    <button type="submit">Cadastrar</button>
    
    <p style="margin-top: 15px; text-align: center;">
      J√° tem conta? <a href="#/login">Fa√ßa login aqui</a>
    </p>
  </form>
</div>

<script>
(function() {
  console.log('üìÑ Inicializando p√°gina de cadastro...');
  
  const signupForm = document.getElementById('signupForm');
  const referralCodeGroup = document.getElementById('referralCodeGroup');
  const referralCodeInput = document.getElementById('referralCode');
  const codeValidation = document.getElementById('codeValidation');
  
  if (!signupForm) {
    console.error('‚ùå Formul√°rio de cadastro n√£o encontrado');
    return;
  }

  let validationTimeout;
  
  // Mostrar/ocultar campo de c√≥digo de refer√™ncia
  document.querySelectorAll('input[name="userType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'student') {
        referralCodeGroup.style.display = 'block';
        referralCodeInput.required = true;
      } else {
        referralCodeGroup.style.display = 'none';
        referralCodeInput.required = false;
        referralCodeInput.value = '';
        codeValidation.style.display = 'none';
      }
    });
  });

  // Validar c√≥digo em tempo real
  if (referralCodeInput) {
    referralCodeInput.addEventListener('input', (e) => {
      const code = e.target.value.toUpperCase();
      e.target.value = code;
      
      if (code.length === 6) {
        clearTimeout(validationTimeout);
        validationTimeout = setTimeout(async () => {
          codeValidation.textContent = 'Verificando...';
          codeValidation.style.display = 'block';
          codeValidation.style.color = '#666';
          
          console.log('Validando c√≥digo:', code);
          const result = await authManager.checkReferralCode(code);
          console.log('Resultado valida√ß√£o:', result);
          
          if (result.exists) {
            codeValidation.textContent = '‚úì Personal encontrado: ' + result.personalName;
            codeValidation.style.color = '#00cc00';
          } else {
            codeValidation.textContent = '‚úó C√≥digo inv√°lido';
            codeValidation.style.color = '#cc0000';
          }
        }, 500);
      } else {
        codeValidation.style.display = 'none';
      }
    });
  }
  
  // Remover listeners anteriores
  const newForm = signupForm.cloneNode(true);
  signupForm.parentNode.replaceChild(newForm, signupForm);
  
  // Re-selecionar elementos ap√≥s clonar
  const finalForm = document.getElementById('signupForm');
  const finalReferralCodeGroup = document.getElementById('referralCodeGroup');
  const finalReferralCodeInput = document.getElementById('referralCode');
  const finalCodeValidation = document.getElementById('codeValidation');
  
  // Re-adicionar event listeners no formul√°rio clonado
  document.querySelectorAll('input[name="userType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.value === 'student') {
        finalReferralCodeGroup.style.display = 'block';
        finalReferralCodeInput.required = true;
      } else {
        finalReferralCodeGroup.style.display = 'none';
        finalReferralCodeInput.required = false;
        finalReferralCodeInput.value = '';
        finalCodeValidation.style.display = 'none';
      }
    });
  });
  
  if (finalReferralCodeInput) {
    finalReferralCodeInput.addEventListener('input', (e) => {
      const code = e.target.value.toUpperCase();
      e.target.value = code;
      
      if (code.length === 6) {
        clearTimeout(validationTimeout);
        validationTimeout = setTimeout(async () => {
          finalCodeValidation.textContent = 'Verificando...';
          finalCodeValidation.style.display = 'block';
          finalCodeValidation.style.color = '#666';
          
          const result = await authManager.checkReferralCode(code);
          
          if (result.exists) {
            finalCodeValidation.textContent = '‚úì Personal encontrado: ' + result.personalName;
            finalCodeValidation.style.color = '#00cc00';
          } else {
            finalCodeValidation.textContent = '‚úó C√≥digo inv√°lido';
            finalCodeValidation.style.color = '#cc0000';
          }
        }, 500);
      } else {
        finalCodeValidation.style.display = 'none';
      }
    });
  }
  
  finalForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('signupName').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
    const userTypeElement = document.querySelector('input[name="userType"]:checked');
    const referralCode = document.getElementById('referralCode').value.trim();
    const errorDiv = document.getElementById('signupError');
    const successDiv = document.getElementById('signupSuccess');
    
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    if (password !== passwordConfirm) {
      errorDiv.textContent = 'As senhas n√£o conferem';
      errorDiv.style.display = 'block';
      return;
    }
    
    if (!userTypeElement) {
      errorDiv.textContent = 'Selecione o tipo de usu√°rio';
      errorDiv.style.display = 'block';
      return;
    }
    
    const userType = userTypeElement.value;
    
    if (userType === 'student') {
      if (!referralCode) {
        errorDiv.textContent = 'Digite o c√≥digo do seu Personal Trainer';
        errorDiv.style.display = 'block';
        return;
      }

      if (referralCode.length !== 6) {
        errorDiv.textContent = 'O c√≥digo deve ter exatamente 6 caracteres';
        errorDiv.style.display = 'block';
        return;
      }

      console.log('Verificando c√≥digo antes do cadastro:', referralCode);
      const codeCheck = await authManager.checkReferralCode(referralCode);
      console.log('Verifica√ß√£o final:', codeCheck);
      
      if (!codeCheck.exists) {
        errorDiv.textContent = 'C√≥digo de refer√™ncia inv√°lido. Verifique com seu Personal Trainer.';
        errorDiv.style.display = 'block';
        return;
      }
    }
    
    const submitBtn = finalForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Cadastrando...';
    submitBtn.disabled = true;
    
    try {
      const result = await authManager.signup(
        email, 
        password, 
        name, 
        userType,
        userType === 'student' ? referralCode : null
      );
      
      console.log('Resultado do cadastro:', result);
      
      if (result.success) {
        if (result.userType === 'personal' && result.referralCode) {
          successDiv.innerHTML = `
            <strong>Cadastro realizado com sucesso!</strong><br>
            Seu c√≥digo de refer√™ncia √©: <strong style="font-size: 18px;">${result.referralCode}</strong><br>
            Compartilhe este c√≥digo com seus alunos.<br>
            <small>Redirecionando em 4 segundos...</small>
          `;
          successDiv.style.display = 'block';
          
          setTimeout(() => {
            router.goToPersonalDashboard();
          }, 4000);
        } else {
          successDiv.innerHTML = `
            <strong>Cadastro realizado com sucesso!</strong><br>
            Voc√™ foi vinculado ao seu Personal Trainer.<br>
            <small>Redirecionando em 2 segundos...</small>
          `;
          successDiv.style.display = 'block';
          
          setTimeout(() => {
            router.goToStudentDashboard();
          }, 2000);
        }
      } else {
        errorDiv.textContent = result.error;
        errorDiv.style.display = 'block';
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    } catch (error) {
      console.error('Erro no cadastro:', error);
      errorDiv.textContent = 'Erro ao cadastrar. Tente novamente.';
      errorDiv.style.display = 'block';
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
  
  console.log('‚úì P√°gina de cadastro pronta');
})();
</script>